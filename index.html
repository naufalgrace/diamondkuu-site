<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DiamondKu - Top Up Game & APK Premium</title>
<meta name="description" content="DiamondKu: Top Up Game & Langganan APK Premium termurah, tercepat, dan terpercaya di Indonesia. Proses instan, pembayaran lengkap QRIS & DANA.">
<meta name="keywords" content="top up game, topup game, apk premium, netflix premium, spotify premium, youtube premium, canva pro, chatgpt, mobile legends, free fire, pubg mobile, genshin impact, call of duty mobile, arena of valor, diamondku, topup murah, topup cepat">
<meta name="author" content="DiamondKu">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://www.diamondku.com/"> <!-- Ganti dengan URL asli -->
<meta property="og:title" content="DiamondKu - Top Up Game & APK Premium">
<meta property="og:description" content="DiamondKu: Top Up Game & Langganan APK Premium termurah, tercepat, dan terpercaya di Indonesia. Proses instan, pembayaran lengkap QRIS & DANA.">
<meta property="og:image" content="https://i.imgur.com/2zJqX8f.png"> <!-- Ganti dengan URL logo asli -->

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://www.diamondku.com/"> <!-- Ganti dengan URL asli -->
<meta property="twitter:title" content="DiamondKu - Top Up Game & APK Premium">
<meta property="twitter:description" content="DiamondKu: Top Up Game & Langganan APK Premium termurah, tercepat, dan terpercaya di Indonesia. Proses inster, pembayaran lengkap QRIS & DANA.">
<meta property="twitter:image" content="https://i.imgur.com/2zJqX8f.png"> <!-- Ganti dengan URL logo asli -->

<!-- Favicon -->
<link rel="icon" href="https://i.imgur.com/2zJqX8f.png" type="image/png"> <!-- Ganti dengan URL favicon asli -->

<style>
  /* =================== THEME / VISUAL =================== */
  :root{
    --bg-primary:#1a1a1a; /* Dark background */
    --bg-secondary:#0a0a00; /* Even darker background for cards/sections */
    --bg-card:rgba(30,30,30,.85); /* Semi-transparent card background */
    --text-primary:#fff; /* Primary text color */
    --text-secondary:#ccc; /* Secondary text color */
    --accent:#fbb03b; /* Accent color (orange/gold) */
    --accent-hover:#ffa02b; /* Lighter accent for hover states */
    --border:rgba(255,255,255,.1); /* Subtle border color */
    --shadow:rgba(0,0,0,.45); /* Shadow color */
    --error:#ff4757; /* Error message color */
    --success:#28a745; /* Success message color */
    --focus-ring:rgba(251,176,59,.6); /* Focus ring color */
  }

  /* Base styles */
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
  html{scroll-behavior:smooth}
  body{
    background:linear-gradient(135deg,var(--bg-primary),var(--bg-secondary));
    color:var(--text-primary);
    padding:20px;
    overflow-x:hidden;
    background-attachment:fixed;
    line-height:1.6;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Particles background */
  .particles{position:fixed;inset:0;z-index:-1;overflow:hidden}
  .particle{
    position:absolute;
    background:rgba(251,176,59,.2);
    border-radius:50%;
    pointer-events:none;
    animation:float 18s linear infinite;
    will-change:transform,opacity;
  }
  @keyframes float{
    0%{transform:translateY(100vh) translateX(0);opacity:0}
    10%,90%{opacity:.45}
    100%{transform:translateY(-100vh) translateX(120px);opacity:0}
  }

  /* Header */
  .header{
    display:flex;
    gap:20px;
    align-items:center;
    margin-bottom:22px;
    animation:fadeInDown .8s both;
    flex-wrap:wrap;
  }
  @keyframes fadeInDown{
    from{opacity:0;transform:translateY(-24px)}
    to{opacity:1;transform:none}
  }

  /* Logo */
  .logo{
    width:80px;
    height:80px; /* Ensure square aspect ratio */
    border-radius:12px;
    box-shadow:0 10px 25px rgba(251,176,59,.4);
    overflow:hidden;
    position:relative;
    transition:.5s cubic-bezier(.25,.8,.25,1);
    flex-shrink:0;
  }
  .logo img{display:block;width:100%;height:100%;object-fit:cover;}
  .logo::before{
    content:'';
    position:absolute;
    inset:-50%;
    background:linear-gradient(45deg,transparent,rgba(255,255,255,.35),transparent);
    transform:rotate(45deg);
    opacity:0;
    pointer-events:none;
  }
  .logo:hover{transform:scale(1.05) translateY(-4px);box-shadow:0 15px 35px rgba(251,176,59,.6)}
  .logo:hover::before{animation:shine .6s forwards}
  @keyframes shine{
    0%{transform:translateX(-100%) translateY(-100%) rotate(45deg);opacity:0}
    50%{opacity:1}
    100%{transform:translateX(100%) translateY(100%) rotate(45deg);opacity:0}
  }

  /* User section & Buttons */
  .user-section{margin-left:auto;display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
  .user-btn,.check-order-btn,.auth-btn,.theme-toggle,.notification-btn{
    background:var(--bg-card);
    color:var(--accent);
    border:1px solid var(--border);
    border-radius:50px;
    cursor:pointer;
    transition:.35s cubic-bezier(.25,.8,.25,1);
    font-weight:600;
    font-size:.95rem;
    padding:12px 20px;
    display:flex;
    align-items:center;
    gap:8px;
    text-decoration:none;
    white-space:nowrap;
  }
  .user-btn:focus-visible, .check-order-btn:focus-visible, .auth-btn:focus-visible, .theme-toggle:focus-visible, .notification-btn:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:2px;
  }
  .theme-toggle,.notification-btn{width:45px;height:45px;border-radius:50%;justify-content:center;padding:0;}
  .auth-btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-hover));color:#111;border:none}
  .check-order-btn{position:relative;overflow:hidden}
  .check-order-btn::before{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(90deg,transparent,rgba(251,176,59,.33),transparent);
    transform:translateX(-100%);
    transition:.5s;
    pointer-events:none;
  }
  .check-order-btn:hover::before{transform:translateX(100%)}
  .user-btn:hover,.auth-btn:hover,.theme-toggle:hover,.notification-btn:hover,.check-order-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(251,176,59,.35);
  }

  /* User Dropdown */
  .user-dropdown{
    position:absolute;
    right:20px;
    top:70px;
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:12px;
    display:none;
    min-width:180px;
    box-shadow:0 8px 24px var(--shadow);
    z-index:100;
    padding:8px 0;
  }
  .user-dropdown a{
    display:block;
    padding:10px 16px;
    color:var(--text-secondary);
    text-decoration:none;
    transition:.2s background-color, .2s color;
  }
  .user-dropdown a:hover{background-color:rgba(255,255,255,.08);color:var(--text-primary)}
  .user-dropdown a#logout{color:#ff6b6b}
  .user-dropdown a#logout:hover{background-color:rgba(255,107,107,.1);color:#fff}

  /* Navigation Tabs */
  .nav-container {
    position: relative;
    max-width: 100%;
    margin: 10px auto 24px;
  }

  .nav {
    display: flex;
    gap: 10px;
    flex-wrap: nowrap; /* Prevent wrapping */
    overflow-x: auto;
    justify-content: flex-start;
    padding-bottom: 8px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Hide scrollbar for Firefox */
    scroll-behavior: smooth; /* Smooth scrolling for buttons */
  }
  .nav::-webkit-scrollbar {
    display: none; /* Hide scrollbar for Chrome, Safari, Opera */
  }

  .nav button{
    background:var(--bg-card);
    color:var(--text-secondary);
    border:1px solid var(--border);
    padding:12px 22px;
    border-radius:50px;
    cursor:pointer;
    font-weight:700;
    min-width:140px;
    transition:.25s cubic-bezier(.25,.8,.25,1);
    font-size:.95rem;
    flex-shrink: 0; /* Prevent buttons from shrinking */
  }
  .nav button:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
  .nav button.active{
    background:linear-gradient(135deg,var(--accent),var(--accent-hover));
    color:#111;
    box-shadow:0 8px 24px rgba(251,176,59,.5);
    transform:translateY(-2px);
    border-color:var(--accent);
  }
  .nav button:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:2px;
  }

  .nav-scroll-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(30, 30, 30, 0.85); /* Semi-transparent background */
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--accent);
    cursor: pointer;
    z-index: 10;
    transition: background-color 0.3s, transform 0.3s, opacity 0.3s;
    opacity: 0; /* Hidden by default */
    pointer-events: none; /* Disable interaction when hidden */
  }

  .nav-scroll-btn.visible {
    opacity: 1;
    pointer-events: auto;
  }

  .nav-scroll-btn:hover {
    background-color: rgba(251, 176, 59, 0.1);
    transform: translateY(-50%) scale(1.1);
  }

  .nav-scroll-btn.left {
    left: 0;
  }

  .nav-scroll-btn.right {
    right: 0;
  }

  /* Search & Filter */
  .search-container{max-width:720px;margin:0 auto 18px;}
  .search-wrapper{display:flex;gap:10px;position:relative}
  .search-bar{
    flex:1;
    padding:14px 18px;
    border-radius:50px;
    border:1px solid var(--border);
    background:var(--bg-card);
    color:var(--text-primary);
    font-size:1rem;
    transition:border-color .2s;
  }
  .search-bar::placeholder{color:var(--text-secondary)}
  .search-bar:focus{outline:none;border-color:var(--accent)}
  .filter-btn{
    border-radius:50px;
    padding:0 16px;
    background:var(--bg-card);
    color:var(--accent);
    border:1px solid var(--border);
    cursor:pointer;
    font-size:1.2rem;
    transition:.25s;
    display:grid;place-items:center;
  }
  .filter-btn:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,.2)}
  .filter-btn:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:2px;
  }

  .filter-dropdown{
    position:absolute;
    left:0;
    right:0;
    max-width:720px;
    margin:8px auto 0;
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:16px;
    display:none;
    z-index:50;
    box-shadow:0 8px 24px var(--shadow);
    animation:fadeIn .3s ease-out;
  }
  .filter-dropdown.active{display:block}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:none}}

  .filter-group{margin-bottom:12px}
  .filter-group label{display:block;margin-bottom:8px;color:var(--accent);font-weight:700;font-size:.9rem}
  .filter-option{
    display:inline-block;
    margin:6px 8px 0 0;
    padding:8px 14px;
    border-radius:18px;
    border:1px solid var(--border);
    background:var(--bg-secondary);
    color:var(--text-secondary);
    cursor:pointer;
    font-size:.9rem;
    transition:.2s background-color, .2s color, .2s border-color;
  }
  .filter-option:hover{background:rgba(251,176,59,.1);color:var(--accent);border-color:var(--accent)}
  .filter-option.active{background:var(--accent);color:#111;border-color:var(--accent);font-weight:600}
  .filter-option:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:2px;
  }

  .filter-actions{text-align:right;margin-top:10px}

  /* Sections */
  .section{display:none;opacity:0;transform:translateY(16px);transition:.35s ease-out}
  .section.active{display:block;opacity:1;transform:none}
  .section-title{color:var(--accent);font-size:1.8rem;margin:10px 0 8px;text-align:center;font-weight:800}
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
    gap:22px;
    margin-top:16px;
  }

  /* Card styles */
  .card{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:18px;
    overflow:hidden;
    box-shadow:0 8px 26px var(--shadow);
    cursor:pointer;
    transition:.35s cubic-bezier(.25,.8,.25,1);
    position:relative;
    height:290px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .card:hover{
    transform:translateY(-10px) scale(1.02);
    box-shadow:0 22px 48px var(--shadow),0 0 32px rgba(251,176,59,.25);
    border-color:var(--accent);
  }
  .card:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:2px;
  }
  .card img{
    width:100%;
    height:170px;
    object-fit:cover;
    filter:brightness(.95);
    transition:.35s cubic-bezier(.25,.8,.25,1);
    will-change:transform,filter;
  }
  .card:hover img{transform:scale(1.08);filter:brightness(1.1) contrast(1.05)}
  .card-text{
    padding:16px;
    text-align:center;
    font-weight:800;
    color:var(--accent);
    font-size:1.1rem;
    flex-grow:1;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .wishlist-btn{
    position:absolute;
    top:10px;
    right:10px;
    width:36px;
    height:36px;
    border-radius:50%;
    display:grid;
    place-items:center;
    border:none;
    background:rgba(30,30,30,.7);
    color:#fff;
    font-size:1.2rem;
    cursor:pointer;
    transition:.2s background-color, .2s transform;
    z-index:10;
  }
  .wishlist-btn:hover{transform:scale(1.1)}
  .wishlist-btn.active{background:rgba(220,53,69,.85)}
  .wishlist-btn:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:2px;
  }

  /* Modals */
  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.96);
    backdrop-filter:blur(12px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1000;
    opacity:0;
    transition:.35s ease-out;
  }
  .modal-overlay.active{display:flex;opacity:1}
  .modal-content{
    background:var(--bg-card);
    border:1px solid var(--border);
    width:min(95vw,680px);
    max-height:92vh;
    overflow-y:auto; /* Changed to auto for better UX */
    border-radius:22px;
    padding:26px 26px 30px;
    box-shadow:0 24px 70px var(--shadow),0 0 0 1px rgba(251,176,59,.16);
    position:relative;
    animation:zoomIn .3s ease-out;
  }
  @keyframes zoomIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:none}}

  .close-btn{
    position:absolute;
    top:16px;
    right:16px;
    width:44px;
    height:44px;
    border-radius:50%;
    border:none;
    background:var(--bg-secondary);
    color:var(--accent);
    font-size:22px;
    font-weight:900;
    cursor:pointer;
    transition:.2s transform, .2s background-color;
    display:grid;place-items:center;
  }
  .close-btn:hover{transform:rotate(90deg);background-color:rgba(251,176,59,.1)}
  .close-btn:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:2px;
  }

  .order-title{text-align:center;color:var(--accent);font-size:1.9rem;margin:10px 0 18px;font-weight:800}
  .form-group{margin-bottom:16px}
  label{display:block;margin-bottom:8px;color:var(--accent);font-weight:700;font-size:.9rem}
  input,select,textarea{
    width:100%;
    padding:14px;
    border-radius:14px;
    border:1px solid var(--border);
    background:var(--bg-card);
    color:var(--text-primary);
    font-size:1rem;
    transition:border-color .2s;
  }
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
  input::placeholder,textarea::placeholder{color:var(--text-secondary)}
  textarea{min-height:96px;resize:vertical}

  .submit-btn,.back-btn,.ghost-btn{
    width:100%;
    padding:16px;
    border-radius:14px;
    border:none;
    font-weight:900;
    cursor:pointer;
    margin-top:10px;
    font-size:1rem;
    transition:.2s transform, .2s box-shadow;
  }
  .submit-btn{background:linear-gradient(135deg,var(--accent),var(--accent-hover));color:#111}
  .back-btn{background:var(--bg-secondary);color:var(--accent);border:1px solid var(--border)}
  .ghost-btn{background:transparent;color:var(--accent);border:1px dashed var(--accent)}
  .submit-btn:hover,.back-btn:hover,.ghost-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
  .submit-btn:focus-visible,.back-btn:focus-visible,.ghost-btn:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:2px;
  }

  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .nominal-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
  .nominal-card{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px;
    text-align:center;
    cursor:pointer;
    position:relative;
    transition:.25s cubic-bezier(.25,.8,.25,1);
  }
  .nominal-card:hover{border-color:var(--accent);transform:translateY(-3px)}
  .nominal-card.selected{
    background:linear-gradient(135deg,rgba(251,176,59,.18),rgba(255,160,43,.08));
    border-color:var(--accent);
    box-shadow:0 0 18px rgba(251,176,59,.35);
  }
  .nominal-card:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:2px;
  }
  .nominal-value{color:var(--accent);font-weight:900;font-size:1.1rem}
  .nominal-price{color:var(--text-secondary);font-size:.95rem;margin-top:4px}
  .nominal-bonus{
    position:absolute;
    top:8px;
    right:8px;
    background:linear-gradient(135deg,#ff4757,#ff3838);
    color:#fff;
    border-radius:18px;
    padding:3px 8px;
    font-size:.7rem;
    font-weight:800;
    text-transform:uppercase;
  }
  .warn{
    display:none;
    margin-bottom:12px;
    background:rgba(255,71,87,.1);
    border:1px solid var(--error);
    color:var(--error);
    padding:10px;
    border-radius:12px;
    font-size:.9rem;
  }
  .warn.active{display:block;animation:shake .45s}
  @keyframes shake{
    0%,100%{transform:translateX(0)}
    20%,60%{transform:translateX(-6px)}
    40%,80%{transform:translateX(6px)}
  }

  /* Payment sheet */
  .paybox{background:var(--bg-secondary);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:12px}
  .meta{display:flex;gap:10px;flex-wrap:wrap}
  .chip{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    color:var(--text-secondary);
    font-size:.9rem;
    background:rgba(255,255,255,.05);
  }
  .accent{color:var(--accent)}
  .center{text-align:center}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}

  /* Confetti */
  .confetti{pointer-events:none;position:fixed;inset:0;overflow:hidden;z-index:2000}
  .confetti .c{position:absolute;width:10px;height:14px;opacity:0;animation:drop 1800ms ease-out forwards}
  @keyframes drop{
    0%{transform:translateY(-10vh) rotate(0);opacity:.9}
    70%{opacity:1}
    100%{transform:translateY(110vh) rotate(720deg);opacity:0}
  }

  /* Timeline tracking */
  .tracking{display:flex;justify-content:space-between;position:relative;margin:18px 0}
  .tracking::before{content:'';position:absolute;left:40px;right:40px;top:22px;height:3px;background:var(--border);border-radius:2px}
  .t-step{width:84px;text-align:center;position:relative;z-index:1}
  .t-ico{
    width:44px;
    height:44px;
    border-radius:50%;
    display:grid;
    place-items:center;
    background:var(--bg-secondary);
    border:2px solid var(--border);
    margin:0 auto 8px;
    font-weight:900;
    font-size:1.1rem;
    transition:.3s all ease;
  }
  .t-ico.active{background:var(--accent);color:#111;border-color:var(--accent);box-shadow:0 0 15px rgba(251,176,59,.55)}
  .t-ico.done{background:rgba(251,176,59,.25);color:var(--accent);border-color:var(--accent)}
  .t-name{font-size:.85rem;color:var(--text-secondary);margin-top:4px}
  .progress{
    position:absolute;
    top:22px;
    left:40px;
    height:3px;
    background:linear-gradient(90deg,var(--accent),var(--accent-hover));
    border-radius:2px;
    width:0%;
    transition:width .9s ease-out;
  }

  /* FAQ */
  .faq-item{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:16px;
    overflow:hidden;
    margin-bottom:10px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
  }
  .faq-q{
    padding:16px 18px;
    color:var(--accent);
    font-weight:900;
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
    font-size:1rem;
    transition:.2s background-color;
  }
  .faq-q:hover{background-color:rgba(251,176,59,.08)}
  .faq-q:focus-visible {
    outline:2px solid var(--focus-ring);
    outline-offset:-2px;
  }
  .faq-a{
    max-height:0;
    overflow:hidden;
    transition:max-height .35s ease,padding .35s ease;
    padding:0 18px;
    color:var(--text-secondary);
    font-size:.95rem;
  }
  .faq-item.active .faq-a{max-height:380px;padding:0 18px 16px}
  .faq-icon{transition:transform .25s}.faq-item.active .faq-icon{transform:rotate(180deg)}

  /* Toast */
  .toast{
    position:fixed;
    left:50%;
    top:26px;
    transform:translateX(-50%) translateY(-18px);
    padding:14px 18px;
    border-radius:12px;
    background:linear-gradient(135deg,rgba(251,176,59,.95),rgba(255,160,43,.9));
    color:#111;
    font-weight:900;
    z-index:3000;
    opacity:0;
    transition:.35s ease-out;
    box-shadow:0 8px 24px rgba(0,0,0,.3);
  }
  .toast.show{opacity:1;transform:translateX(-50%)}

  /* Footer */
  .footer {
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    padding: 30px 20px;
    margin-top: 40px;
    text-align: center;
    color: var(--text-secondary);
    border-radius: 18px 18px 0 0;
  }

  .footer-section {
    margin-bottom: 20px;
  }

  .footer-section h3 {
    color: var(--accent);
    font-size: 1.2rem;
    margin-bottom: 10px;
  }

  .footer-section p, .footer-section a {
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-decoration: none;
    display: block;
    margin-bottom: 5px;
  }

  .footer-section a:hover {
    color: var(--accent);
  }

  .footer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    max-width: 960px;
    margin: 0 auto 30px;
    text-align: left;
  }

  /* Responsive */
  @media(max-width:768px){
    body{padding:15px}
    .header{flex-direction:column;align-items:flex-start;gap:15px}
    .user-section{margin-left:0;width:100%;justify-content:center}
    .nav-container {
      padding: 0 45px; /* Make space for scroll buttons */
    }
    .nav{
      flex-wrap:nowrap;
      overflow-x:auto;
      justify-content:flex-start;
      padding-bottom:8px;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    .nav::-webkit-scrollbar{display:none}
    .nav button{min-width:100px;padding:10px 16px;font-size:.85rem;flex-shrink:0}
    .search-wrapper{flex-direction:column;gap:15px}
    .filter-btn{width:100%;height:auto;padding:12px 16px;font-size:1rem}
    .filter-dropdown{position:static;max-width:none;margin-top:10px}
    .row{grid-template-columns:1fr}
    .card{height:260px}.card img{height:150px}
    .modal-content{padding:20px}
    .order-title{font-size:1.6rem}
    .close-btn{top:10px;right:10px;width:38px;height:38px;font-size:18px}
    .footer-grid {
      grid-template-columns: 1fr;
      text-align: center;
    }
  }
</style>
</head>
<body>
  <!-- Particles background -->
  <div class="particles" id="particles" aria-hidden="true"></div>

  <header class="header" role="banner">
    <a href="#" class="logo" aria-label="DiamondKu Home">
      <img src="https://i.imgur.com/2zJqX8f.png" alt="DiamondKu Logo">
    </a>
    <div class="user-section">
      <div id="userMenu" role="navigation" aria-label="User Account Menu"></div>
      <button class="check-order-btn" id="openCheck" aria-label="Cek Status Pesanan Anda">Cek Pesanan</button>
    </div>
  </header>

  <div class="nav-container">
    <button class="nav-scroll-btn left" id="scrollLeftBtn" aria-label="Scroll tab ke kiri" style="display: none;">&lt;</button>
    <nav class="nav" role="navigation" aria-label="Main Navigation">
      <button class="tab-btn active" data-tab="popular" aria-controls="popular" aria-selected="true">Populer</button>
      <button class="tab-btn" data-tab="games" aria-controls="games" aria-selected="false">Top Up Game</button>
      <button class="tab-btn" data-tab="apk" aria-controls="apk" aria-selected="false">APK Premium</button>
      <button class="tab-btn" data-tab="orderHistory" aria-controls="orderHistory" aria-selected="false">Riwayat Pesanan</button>
      <button class="tab-btn" data-tab="wishlist" aria-controls="wishlist" aria-selected="false">Wishlist</button>
      <button class="tab-btn" data-tab="testimonials" aria-controls="testimonials" aria-selected="false">Testimoni</button>
      <button class="tab-btn" data-tab="faq" aria-controls="faq" aria-selected="false">FAQ</button>
      <button class="tab-btn" data-tab="promos" aria-controls="promos" aria-selected="false">Promo</button>
    </nav>
    <button class="nav-scroll-btn right" id="scrollRightBtn" aria-label="Scroll tab ke kanan" style="display: none;">&gt;</button>
  </div>

  <main role="main">
    <!-- Search -->
    <section class="search-container" aria-label="Pencarian dan Filter Produk">
      <div class="search-wrapper">
        <input type="search" class="search-bar" id="searchInput" placeholder="Cari game atau produk..." aria-label="Cari game atau produk">
        <button class="filter-btn" id="filterToggle" aria-expanded="false" aria-controls="filterDropdown" aria-label="Buka Filter Pencarian">⚡</button>
        <div class="filter-dropdown" id="filterDropdown" role="region" aria-live="polite">
          <div class="filter-group">
            <label>Kategori</label>
            <div role="group" aria-label="Pilih Kategori Produk">
              <span class="filter-option active" data-filter="all" tabindex="0" role="button" aria-pressed="true">Semua</span>
              <span class="filter-option" data-filter="game" tabindex="0" role="button" aria-pressed="false">Game</span>
              <span class="filter-option" data-filter="apk" tabindex="0" role="button" aria-pressed="false">APK</span>
              <span class="filter-option" data-filter="promo" tabindex="0" role="button" aria-pressed="false">Promo</span>
            </div>
          </div>
          <div class="filter-group">
            <label>Harga</label>
            <div role="group" aria-label="Pilih Rentang Harga">
              <span class="filter-option active" data-price="all" tabindex="0" role="button" aria-pressed="true">Semua</span>
              <span class="filter-option" data-price="low" tabindex="0" role="button" aria-pressed="false">Di bawah Rp 50.000</span>
              <span class="filter-option" data-price="medium" tabindex="0" role="button" aria-pressed="false">Rp 50.000 - Rp 200.000</span>
              <span class="filter-option" data-price="high" tabindex="0" role="button" aria-pressed="false">Di atas Rp 200.000</span>
            </div>
          </div>
          <div class="filter-actions">
            <button class="ghost-btn" id="filterReset" aria-label="Reset Filter">Reset</button>
            <button class="submit-btn" id="filterApply" aria-label="Terapkan Filter">Terapkan</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Sections -->
    <section class="section active" id="popular" role="tabpanel" aria-labelledby="popular-tab">
      <h2 class="section-title">Populer</h2>
      <div class="grid" id="popularGrid"></div>
    </section>

    <section class="section" id="games" role="tabpanel" aria-labelledby="games-tab" hidden>
      <h2 class="section-title">Top Up Game</h2>
      <div class="grid" id="gamesGrid"></div>
    </section>

    <section class="section" id="apk" role="tabpanel" aria-labelledby="apk-tab" hidden>
      <h2 class="section-title">APK Premium</h2>
      <div class="grid" id="apkGrid"></div>
    </section>

    <section class="section" id="orderHistory" role="tabpanel" aria-labelledby="orderHistory-tab" hidden>
      <h2 class="section-title">Riwayat Pesanan</h2>
      <div id="orderHistoryContainer"></div>
    </section>

    <section class="section" id="wishlist" role="tabpanel" aria-labelledby="wishlist-tab" hidden>
      <h2 class="section-title">Wishlist Saya</h2>
      <div class="grid" id="wishlistContainer"></div>
    </section>

    <section class="section" id="testimonials" role="tabpanel" aria-labelledby="testimonials-tab" hidden>
      <h2 class="section-title">Testimoni Pelanggan</h2>
      <div class="grid" id="testiGrid"></div>
    </section>

    <section class="section" id="faq" role="tabpanel" aria-labelledby="faq-tab" hidden>
      <h2 class="section-title">Frequently Asked Questions</h2>
      <div class="faq-container" id="faqWrap"></div>
    </section>

    <section class="section" id="promos" role="tabpanel" aria-labelledby="promos-tab" hidden>
      <h2 class="section-title">Promo Terkini</h2>
      <div class="grid" id="promoGrid"></div>
    </section>
  </main>

  <!-- ============ MODALS ============ -->
  <!-- Login Modal -->
  <div class="modal-overlay" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" data-close="loginModal" aria-label="Tutup dialog masuk">×</button>
      <h2 class="order-title" id="loginModalTitle">Masuk</h2>
      <form id="loginForm" aria-label="Formulir Masuk">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="loginPass">Password</label>
          <input type="password" id="loginPass" required autocomplete="current-password">
        </div>
        <button class="submit-btn" type="submit">Masuk</button>
      </form>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal-overlay" id="registerModal" role="dialog" aria-modal="true" aria-labelledby="registerModalTitle" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" data-close="registerModal" aria-label="Tutup dialog daftar">×</button>
      <h2 class="order-title" id="registerModalTitle">Daftar</h2>
      <form id="regForm" aria-label="Formulir Daftar">
        <div class="form-group">
          <label for="regName">Nama</label>
          <input type="text" id="regName" name="name" required autocomplete="name">
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input type="email" id="regEmail" name="email" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="regPass">Password</label>
          <input type="password" id="regPass" name="password" required autocomplete="new-password">
        </div>
        <button class="submit-btn" type="submit">Daftar</button>
      </form>
    </div>
  </div>

  <!-- Order Modal -->
  <div class="modal-overlay" id="orderModal" role="dialog" aria-modal="true" aria-labelledby="orderModalTitle" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" data-close="orderModal" aria-label="Tutup formulir pemesanan">×</button>
      <h2 class="order-title" id="orderModalTitle">Formulir Pemesanan</h2>
      <form id="orderForm">
        <div class="form-group" id="fgProduct">
          <label for="product">Produk</label>
          <input type="text" id="product" name="product" readonly aria-readonly="true">
        </div>
        <div class="warn" id="emailFreshWarn" style="display:none" role="alert">Gunakan Gmail <b>fresh/buat baru</b> (belum pernah dipakai) untuk aktivasi Canva/ChatGPT/YouTube.</div>
        <div class="row">
          <div class="form-group" id="fgUserId">
            <label id="lblUserId" for="userId">ID Pengguna</label>
            <input type="text" id="userId" name="userId" placeholder="Contoh: 123456789 (ID Game)" required>
          </div>
          <div class="form-group" id="fgServer">
            <label id="lblServer" for="server">Server (jika ada)</label>
            <input type="text" id="server" name="server" placeholder="Contoh: Asia / 2156 (isi jika ada)">
          </div>
        </div>
        <div class="row">
          <div class="form-group" id="fgNickname">
            <label id="lblNickname" for="nickname">Nama Panggilan</label>
            <input type="text" id="nickname" name="nickname" placeholder="Contoh: BangDaimond / PlayerOne">
          </div>
          <div class="form-group" id="fgPhone">
            <label id="lblPhone" for="phoneNumber">Nomor HP</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="Contoh: 081234567890" required autocomplete="tel">
          </div>
        </div>

        <div class="form-group" id="fgNominal">
          <label>Pilih Nominal</label>
          <div class="warn" id="nominalWarn" role="alert">Silakan pilih nominal terlebih dahulu.</div>
          <div class="nominal-cards" id="nominalCards" role="group" aria-label="Pilihan Nominal Produk"></div>
          <input type="hidden" id="selectedNominal" name="nominal">
          <input type="hidden" id="selectedPrice" name="price">
        </div>

        <div class="form-group" id="fgPayment">
          <label for="payment">Metode Pembayaran</label>
          <select id="payment" name="payment" required>
            <option value="">Pilih metode</option>
            <option value="qris">QRIS</option>
            <option value="dana">DANA</option>
          </select>
        </div>

        <button class="submit-btn" type="submit">Pesan Sekarang</button>
        <button class="back-btn" type="button" data-close="orderModal">Kembali</button>
      </form>
    </div>
  </div>

  <!-- Confirmation Modal (Ringkasan) -->
  <div class="modal-overlay" id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" data-close="confirmModal" aria-label="Tutup ringkasan pesanan">×</button>
      <h2 class="order-title" id="confirmModalTitle">Ringkasan Pesanan</h2>

      <div class="paybox" id="summaryBox" aria-live="polite">
        <!-- Diisi dinamis -->
      </div>

      <div class="paybox mt12" id="paymentBox">
        <div class="center">
          <div class="accent" style="font-weight:900;margin-bottom:6px">Pembayaran</div>
          <div id="payInstruction" style="color:var(--text-secondary)"></div>
          <div class="meta mt12" id="payMeta"></div>
          <div class="mt12" id="countdownWrap" style="display:none">
            <span class="chip">Batas bayar: <b id="countdown" aria-live="polite">15:00</b></span>
          </div>
        </div>
      </div>

      <div class="row mt16">
        <button class="submit-btn" id="alreadyPaidBtn">Sudah Bayar</button>
        <button class="back-btn" type="button" data-close="confirmModal">Kembali</button>
      </div>
    </div>
  </div>

  <!-- Upload Bukti + Nomor Transaksi Modal -->
  <div class="modal-overlay" id="proofModal" role="dialog" aria-modal="true" aria-labelledby="proofModalTitle" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" data-close="proofModal" aria-label="Tutup formulir upload bukti">×</button>
      <h2 class="order-title" id="proofModalTitle">Upload Bukti & Nomor Transaksi</h2>

      <div class="paybox">
        <div class="row">
          <div class="form-group">
            <label for="proofOrderId">ID Pesanan</label>
            <input type="text" id="proofOrderId" readonly aria-readonly="true">
          </div>
          <div class="form-group">
            <label for="trxNo">Nomor Transaksi</label>
            <input type="text" id="trxNo" placeholder="Contoh: TRX-20250910-ABC">
          </div>
        </div>
        <div class="form-group">
          <label for="proofFile">Bukti Transfer (JPG/PNG/PDF maks. 2MB)</label>
          <input type="file" id="proofFile" accept="image/*,.pdf">
        </div>
      </div>

      <div class="row mt12">
        <button class="submit-btn" id="sendProofBtn">Upload & Kirim</button>
        <button class="back-btn" type="button" data-close="proofModal">Kembali</button>
      </div>

      <div class="center mt12">
        <button class="ghost-btn" id="sendToGroupBtn">Kirim Pesanan ke Grup</button>
        <p style="color:var(--text-secondary);font-size:.9rem;margin-top:6px">Akan membuka WhatsApp/Telegram dengan pesan terformat.</p>
      </div>
    </div>
  </div>

  <!-- Check Order Modal (ID saja) -->
  <div class="modal-overlay" id="checkOrderModal" role="dialog" aria-modal="true" aria-labelledby="checkOrderModalTitle" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" data-close="checkOrderModal" aria-label="Tutup status pesanan">×</button>
      <h2 class="order-title" id="checkOrderModalTitle">Cek Status Pesanan</h2>
      <form id="checkOrderForm">
        <div class="form-group">
          <label for="checkOrderId">ID Pesanan</label>
          <input type="text" id="checkOrderId" placeholder="Masukkan ID Pesanan (Contoh: DK12345)" required>
        </div>
        <button class="submit-btn" type="submit">Cek Pesanan</button>
      </form>

      <div id="trackingWrap" style="display:none" class="mt16" role="region" aria-live="polite">
        <h3 class="center accent" id="trackingTitle">Status Pesanan</h3>
        <div class="tracking" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          <div class="progress" id="trackProgress"></div>
          <div class="t-step">
            <div class="t-ico done" aria-hidden="true">✓</div>
            <div class="t-name">Dibuat</div>
          </div>
          <div class="t-step">
            <div class="t-ico" id="tPay" aria-hidden="true">○</div>
            <div class="t-name">Bayar</div>
          </div>
          <div class="t-step">
            <div class="t-ico" id="tProc" aria-hidden="true">○</div>
            <div class="t-name">Proses</div>
          </div>
          <div class="t-step">
            <div class="t-ico" id="tDone" aria-hidden="true">○</div>
            <div class="t-name">Selesai</div>
          </div>
        </div>

        <div class="paybox" id="trackDetail"></div>
        <button class="back-btn mt12" type="button" data-close="checkOrderModal">Tutup</button>
      </div>
    </div>
  </div>

  <!-- Confetti container & Toast -->
  <div class="confetti" id="confetti" aria-hidden="true"></div>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Footer -->
  <footer class="footer" role="contentinfo">
    <div class="footer-grid">
      <div class="footer-section">
        <h3>Kontak Kami</h3>
        <p>Email: support@diamondku.com</p>
        <p>WhatsApp: +62 812-3456-7890</p>
        <p>Jam Kerja: 09:00 - 22:00 WIB</p>
      </div>
      <div class="footer-section">
        <h3>Informasi Toko</h3>
        <p>DiamondKu adalah platform top up game dan langganan APK premium terpercaya di Indonesia.</p>
        <p>Kami berkomitmen menyediakan layanan tercepat dan termurah untuk kebutuhan digital Anda.</p>
      </div>
      <div class="footer-section">
        <h3>Kebijakan</h3>
        <a href="#kebijakan-layanan">Kebijakan Layanan</a>
        <a href="#kebijakan-refund">Kebijakan Refund</a>
        <a href="#kebijakan-privasi">Kebijakan Privasi</a>
      </div>
    </div>
    <p>&copy; 2024 DiamondKu. Semua Hak Dilindungi.</p>
  </footer>

  <!-- Kebijakan Layanan / Refund / Privasi Section -->
  <section class="section" id="kebijakan-layanan" role="tabpanel" aria-labelledby="kebijakan-layanan-tab" hidden>
    <h2 class="section-title">Kebijakan Layanan</h2>
    <div class="paybox">
      <p>Dengan menggunakan layanan DiamondKu, Anda menyetujui syarat dan ketentuan berikut:</p>
      <ul>
        <li>Semua transaksi bersifat final setelah pembayaran dikonfirmasi.</li>
        <li>Pastikan data yang Anda masukkan (ID game, server, email) sudah benar. Kesalahan input data oleh pengguna bukan tanggung jawab kami.</li>
        <li>Proses pengiriman produk akan dilakukan secepatnya setelah pembayaran terverifikasi.</li>
        <li>Kami berhak menolak atau membatalkan pesanan jika terindikasi adanya aktivitas penipuan atau pelanggaran syarat layanan.</li>
      </ul>
    </div>
  </section>

  <section class="section" id="kebijakan-refund" role="tabpanel" aria-labelledby="kebijakan-refund-tab" hidden>
    <h2 class="section-title">Kebijakan Refund</h2>
    <div class="paybox">
      <p>Kebijakan refund kami adalah sebagai berikut:</p>
      <ul>
        <li>Refund hanya akan diberikan jika produk tidak terkirim dalam waktu 24 jam setelah pembayaran terverifikasi dan bukan karena kesalahan input data dari pihak pembeli.</li>
        <li>Permintaan refund harus disertai dengan bukti pembayaran yang valid dan ID pesanan.</li>
        <li>Refund tidak berlaku untuk produk yang sudah berhasil terkirim atau diaktifkan.</li>
        <li>Proses refund dapat memakan waktu 3-7 hari kerja tergantung metode pembayaran.</li>
      </ul>
    </div>
  </section>

  <section class="section" id="kebijakan-privasi" role="tabpanel" aria-labelledby="kebijakan-privasi-tab" hidden>
    <h2 class="section-title">Kebijakan Privasi</h2>
    <div class="paybox">
      <p>Kami sangat menjaga privasi data Anda:</p>
      <ul>
        <li>Data pribadi yang Anda berikan (nama, email, nomor telepon) hanya akan digunakan untuk keperluan transaksi dan komunikasi terkait pesanan Anda.</li>
        <li>Kami tidak akan membagikan data pribadi Anda kepada pihak ketiga tanpa persetujuan Anda, kecuali diwajibkan oleh hukum.</li>
        <li>Informasi akun game atau layanan premium yang Anda berikan akan dijaga kerahasiaannya dan hanya digunakan untuk proses top up/aktivasi.</li>
        <li>Situs kami menggunakan cookie untuk meningkatkan pengalaman pengguna. Dengan melanjutkan penggunaan situs, Anda menyetujui penggunaan cookie kami.</li>
      </ul>
    </div>
  </section>

<script>
/* ===================== DATA ===================== */
const apkProducts = ['Netflix Premium','Spotify Premium','YouTube Premium','Canva Pro','Adobe Creative Cloud','Microsoft 365', 'ChatGPT'];

let productData = {};

let catalog = [];

/* ===================== STATE ===================== */
// let currentUser = JSON.parse(localStorage.getItem('currentUser')||'null'); // Disabled for Firebase
// let users = JSON.parse(localStorage.getItem('users')||'[]'); // Disabled for Firebase
let orders = []; // Now managed by Firestore
let wishlist = []; // Now managed by Firestore

function save(k,v){localStorage.setItem(k,JSON.stringify(v))} // Keep for other localStorage uses if any
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}

/* ===================== PARTICLES ===================== */
(function createParticles(){
  const p=document.getElementById('particles');
  for(let i=0;i<34;i++){
    const e=document.createElement('div');
    e.className='particle';
    const s=Math.random()*6+3;
    e.style.width=s+'px';
    e.style.height=s+'px';
    e.style.left=(Math.random()*100)+'%';
    const d=Math.random()*18+12,dl=Math.random()*22;
    e.style.animationDuration=d+'s';
    e.style.animationDelay=dl+'s';
    p.appendChild(e);
  }
})();

/* ===================== CONFETTI (EFEK MERIAH) ===================== */
function boomConfetti(intensity=110){
  const wrap=document.getElementById('confetti');
  const colors=['#fbb03b','#ffd166','#00e5ff','#ff006e','#06d6a0'];
  for(let i=0;i<intensity;i++){
    const c=document.createElement('div');
    c.className='c';
    const size=8+Math.random()*8;
    c.style.width=size+'px';
    c.style.height=(size*1.2)+'px';
    c.style.left=(Math.random()*100)+'%';
    c.style.background=colors[i%colors.length];
    c.style.animationDelay=(Math.random()*250)+'ms';
    c.style.transform=`translateY(-10vh) rotate(${Math.random()*360}deg)`;
    wrap.appendChild(c);
    setTimeout(()=>c.remove(),2000);
  }
}

/* ===================== RENDER CATALOG ===================== */
function renderSection(gridId, filterFn){
  const grid=document.getElementById(gridId);
  grid.innerHTML='';
  catalog.filter(filterFn).forEach(item=>{
    const card=document.createElement('div');
    card.className='card';
    card.setAttribute('tabindex', '0'); // Make cards focusable
    card.setAttribute('role', 'button'); // Indicate it's clickable
    card.setAttribute('aria-label', `Pesan ${item.name}`);

    // A) Tambah harga ringkas
    let minPriceHtml = '';
    const productNominals = productData[item.name];
    if (productNominals && productNominals.length > 0) {
      const minPrice = Math.min(...productNominals.map(a => (a.priceFinal ?? a.price)));
      minPriceHtml = `
        <div class="card-price" style="text-align:center;color:var(--text-secondary);margin:-6px 0 10px;font-weight:700">
          Mulai <span class="accent">Rp ${minPrice.toLocaleString('id-ID')}</span>
        </div>`;
    }

    card.innerHTML=`
      <button class="wishlist-btn" title="Tambahkan ke Wishlist" aria-label="Tambahkan ${item.name} ke Wishlist">♥</button>
      <img src="${item.img}" alt="${item.name} cover" width="200" height="170" loading="lazy">
      <div class="card-text">${item.name}</div>
      ${minPriceHtml}`;
    card.addEventListener('click',()=>openOrderModal(item.name));
    const wl=card.querySelector('.wishlist-btn');
    wl.addEventListener('click',(e)=>{e.stopPropagation();toggleWishlist(item.name,wl)});
    grid.appendChild(card);
  });
}

function renderAllCatalog(){
  // Populer = campur 12 item (6 game + 6 apk)
  renderSection('popularGrid', _=>true);
  renderSection('gamesGrid', i=>i.cat==='game');
  renderSection('apkGrid', i=>i.cat==='apk');
}

/* ===================== USER MENU ===================== */
function initUserMenu(user){
  const el=document.getElementById('userMenu');
  if(user){
    el.innerHTML=`
      <button class="user-btn" id="userBtn" aria-expanded="false" aria-controls="userDrop">${user.displayName || user.email} ▾</button>
      <div class="user-dropdown" id="userDrop" role="menu" aria-orientation="vertical">
        <a href="#" id="goHist" role="menuitem">Riwayat Pesanan</a>
        <a href="#" id="goWish" role="menuitem">Wishlist</a>
        <a href="#" id="logoutBtn" role="menuitem">Keluar</a>
      </div>`;
    const btn=document.getElementById('userBtn');
    const drop=document.getElementById('userDrop');
    btn.onclick=()=>{
      const isExpanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', !isExpanded);
      drop.style.display=isExpanded?'none':'block';
    };
    document.getElementById('logoutBtn').onclick=(e)=>{e.preventDefault();window.firebaseSignOut();}; // Use window.firebaseSignOut
    document.getElementById('goHist').onclick=(e)=>{e.preventDefault();showSection('orderHistory'); drop.style.display='none';};
    document.getElementById('goWish').onclick=(e)=>{e.preventDefault();showSection('wishlist'); drop.style.display='none';};
    document.addEventListener('click',(ev)=>{if(!el.contains(ev.target)) drop.style.display='none'});
  }else{
    el.innerHTML=`
      <button class="auth-btn" id="loginOpen" aria-label="Masuk ke akun Anda">Masuk</button>
      <button class="auth-btn primary" id="regOpen" aria-label="Daftar akun baru">Daftar</button>`;
    document.getElementById('loginOpen').onclick=()=>openModal('loginModal'); // Changed to open loginModal
    document.getElementById('regOpen').onclick=()=>openModal('registerModal'); // Changed to open registerModal
  }
}

/* ===================== AUTH ===================== */
document.addEventListener('submit',(e)=>{
  if(e.target.id==='loginForm'){e.preventDefault();
    const email=document.getElementById('loginEmail').value.trim();
    const password=document.getElementById('loginPass').value;
    
    window.firebaseSignIn(email, password); // Use window.firebaseSignIn
  }
  if(e.target.id==='regForm'){e.preventDefault();
    const name=document.getElementById('regName').value.trim();
    const email=document.getElementById('regEmail').value.trim();
    const password=document.getElementById('regPass').value;
    
    window.firebaseRegister(name, email, password); // Use window.firebaseRegister
  }
});

/* ===================== NAV / TABS ===================== */
const nav = document.querySelector('.nav');
const scrollLeftBtn = document.getElementById('scrollLeftBtn');
const scrollRightBtn = document.getElementById('scrollRightBtn');

const checkScrollButtons = () => {
  if (nav.scrollWidth > nav.clientWidth) {
    scrollLeftBtn.classList.add('visible');
    scrollRightBtn.classList.add('visible');
  } else {
    scrollLeftBtn.classList.remove('visible');
    scrollRightBtn.classList.remove('visible');
  }

  // Hide left button if at the start
  if (nav.scrollLeft === 0) {
    scrollLeftBtn.style.display = 'none';
  } else {
    scrollLeftBtn.style.display = 'flex';
  }

  // Hide right button if at the end
  if (nav.scrollLeft + nav.clientWidth >= nav.scrollWidth - 1) { // -1 for potential sub-pixel rendering issues
    scrollRightBtn.style.display = 'none';
  } else {
    scrollRightBtn.style.display = 'flex';
  }
};

const scrollTabs = (direction) => {
  const scrollAmount = nav.clientWidth / 2; // Scroll half the visible width
  if (direction === 'left') {
    nav.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
  } else {
    nav.scrollBy({ left: scrollAmount, behavior: 'smooth' });
  }
};

scrollLeftBtn.addEventListener('click', () => scrollTabs('left'));
scrollRightBtn.addEventListener('click', () => scrollTabs('right'));
nav.addEventListener('scroll', checkScrollButtons);
window.addEventListener('resize', checkScrollButtons);

// Initial check when the page loads
window.addEventListener('load', checkScrollButtons);


document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>{
      b.classList.remove('active');
      b.setAttribute('aria-selected', 'false');
      document.getElementById(b.dataset.tab).setAttribute('hidden', 'true');
    });
    btn.classList.add('active');
    btn.setAttribute('aria-selected', 'true');
    document.getElementById(btn.dataset.tab).removeAttribute('hidden');
    showSection(btn.dataset.tab);
  }
});
function showSection(id){
  document.querySelectorAll('.section').forEach(s=>{s.classList.remove('active');});
  document.getElementById(id).classList.add('active');
  if(id==='orderHistory') loadOrderHistory();
  if(id==='wishlist') loadWishlist();
  // Add event listeners for policy links
  if (id === 'kebijakan-layanan' || id === 'kebijakan-refund' || id === 'kebijakan-privasi') {
    // No specific action needed here, just ensuring the section is shown
  }
}

/* ===================== FILTER + SEARCH ===================== */
const filterToggle=document.getElementById('filterToggle');
const filterDropdown=document.getElementById('filterDropdown');
filterToggle.onclick=()=>{
  const isExpanded = filterToggle.getAttribute('aria-expanded') === 'true';
  filterToggle.setAttribute('aria-expanded', !isExpanded);
  filterDropdown.classList.toggle('active');
};

document.getElementById('filterReset').onclick=()=>{
  filterDropdown.querySelectorAll('.filter-option').forEach(o=>o.classList.remove('active'));
  filterDropdown.querySelector('[data-filter="all"]').classList.add('active');
  filterDropdown.querySelector('[data-price="all"]').classList.add('active');
  toast('Filter direset.');
  applyFilterSearch(
    'all',
    'all',
    document.getElementById('searchInput').value.trim()
  );
}

filterDropdown.addEventListener('click',(e)=>{
  const t=e.target;
  if(!t.classList.contains('filter-option'))return;
  const key=t.dataset.filter?'filter':'price';
  filterDropdown.querySelectorAll(`.filter-option[data-${key}]`).forEach(o=>{
    o.classList.remove('active');
    o.setAttribute('aria-pressed', 'false');
  });
  t.classList.add('active');
  t.setAttribute('aria-pressed', 'true');
});

document.getElementById('filterApply').onclick=()=>{
  const cat=filterDropdown.querySelector('.filter-option[data-filter].active')?.dataset.filter||'all';
  const price=filterDropdown.querySelector('.filter-option[data-price].active')?.dataset.price||'all';
  applyFilterSearch(cat,price,document.getElementById('searchInput').value.trim());
  filterDropdown.classList.remove('active');
  filterToggle.setAttribute('aria-expanded', 'false');
  toast('Filter diterapkan.');
}

let searchTimeout;
document.getElementById('searchInput').addEventListener('input',()=>{
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    applyFilterSearch(
      filterDropdown.querySelector('.filter-option[data-filter].active')?.dataset.filter||'all',
      filterDropdown.querySelector('.filter-option[data-price].active')?.dataset.price||'all',
      document.getElementById('searchInput').value.trim()
    );
  }, 300); // Debounce for 300ms
});

function applyFilterSearch(cat,price,kw){
  const matchPrice=(name)=>{
    const arr=productData[name]||[];if(!arr.length) return true;
    const min=Math.min(...arr.map(a => (a.priceFinal ?? a.price)));
    if(price==='low')return min<50000;
    if(price==='medium')return min>=50000 && min<=200000;
    if(price==='high')return min>200000;
    return true;
  }
  const filterFn=i=>{
    const byCat = (cat==='all')?true:(i.cat===cat || (cat==='promo' && i.cat==='promo'));
    const byKw = kw? i.name.toLowerCase().includes(kw.toLowerCase()):true;
    const byPrice = matchPrice(i.name);
    return byCat && byKw && byPrice;
  }
  renderSection('popularGrid',filterFn);
  renderSection('gamesGrid',i=>filterFn(i)&&i.cat==='game');
  renderSection('apkGrid',i=>filterFn(i)&&i.cat==='apk');
}

/* ===================== WISHLIST ===================== */
async function toggleWishlist(product,btnEl){
  if(!window.currentUserUid){toast('Silakan masuk untuk menambahkan ke Wishlist.');return}
  
  const wishlistCol = window.collection(window.db, 'wishlists'); // Use window.db
  const q = window.query(wishlistCol, window.where('userId', '==', window.currentUserUid), window.where('product', '==', product));
  const snapshot = await window.getDocs(q);

  if(snapshot.empty){
    // Add to wishlist
    await window.addDoc(wishlistCol, {
      userId: window.currentUserUid,
      product: product,
      createdAt: window.serverTimestamp()
    });
    btnEl.classList.add('active');
    btnEl.setAttribute('aria-pressed', 'true');
    toast('Ditambahkan ke Wishlist!');
  } else {
    // Remove from wishlist
    snapshot.docs.forEach(async (d) => {
      await window.deleteDoc(d.ref);
    });
    btnEl.classList.remove('active');
    btnEl.setAttribute('aria-pressed', 'false');
    toast('Dihapus dari Wishlist.');
  }
  // loadWishlist() will be triggered by onSnapshot
}

function loadWishlist(){
  const wrap=document.getElementById('wishlistContainer');wrap.innerHTML='';
  if(!window.currentUserUid){wrap.innerHTML=emptyBox('Anda harus masuk untuk melihat Wishlist.');return}
  
  // This function will be called by the onSnapshot listener in Firebase SDK section
  // The actual rendering happens when the 'wishlist' array is updated by the listener
  if (wishlist.length === 0) {
    wrap.innerHTML = emptyBox('Wishlist Anda kosong.');
    return;
  }

  wishlist.forEach(it=>{
    const info=catalog.find(c=>c.name===it.product) || {name:it.product,img:'https://i.imgur.com/5vQzZqM.png'};
    const card=document.createElement('div');card.className='card';
    card.setAttribute('tabindex', '0');
    card.setAttribute('role', 'button');
    card.setAttribute('aria-label', `Pesan ${info.name}`);
    card.innerHTML=`<button class="wishlist-btn active" aria-pressed="true" title="Hapus dari Wishlist" aria-label="Hapus ${info.name} dari Wishlist">♥</button><img src="${info.img}" alt="${info.name} cover" width="200" height="170" loading="lazy"><div class="card-text">${info.name}</div>`;
    card.onclick=()=>openOrderModal(info.name);
    card.querySelector('.wishlist-btn').onclick=(e)=>{e.stopPropagation();toggleWishlist(info.name,e.currentTarget)}
    wrap.appendChild(card);
  })
}
function emptyBox(msg){return `<div class="empty-state" style="text-align:center;padding:34px;color:var(--text-secondary)"><div style="font-size:40px" aria-hidden="true">🗂️</div><p style="margin-top:8px">${msg}</p></div>`}

/* ===================== MODAL UTILITIES ===================== */
let activeModal = null;
function openModal(id){
  const modal = document.getElementById(id);
  if (modal) {
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    activeModal = modal;
    // Trap focus inside the modal
    const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];

    if (firstFocusable) {
      firstFocusable.focus();
    }

    modal.addEventListener('keydown', function trapFocus(e) {
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstFocusable) {
            lastFocusable.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastFocusable) {
            firstFocusable.focus();
            e.preventDefault();
          }
        }
      } else if (e.key === 'Escape') {
        closeModal(id);
      }
    });
  }
}

function closeModal(id){
  const modal = document.getElementById(id);
  if (modal) {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    activeModal = null;
    // Return focus to the element that opened the modal (if possible)
    // For simplicity, focus returns to body or last focused element before modal.
  }
}
document.querySelectorAll('[data-close]').forEach(b=>b.onclick=()=>closeModal(b.dataset.close));
document.getElementById('openCheck').onclick=()=>openModal('checkOrderModal');

/* ===================== ORDER FORM LOGIC ===================== */
function configureOrderForm(productName) {
  const form = document.getElementById('orderForm');
  const fgProduct  = document.getElementById('fgProduct');
  const fgUserId   = document.getElementById('fgUserId');
  const fgServer   = document.getElementById('fgServer');
  const fgNickname = document.getElementById('fgNickname');
  const fgPhone    = document.getElementById('fgPhone');
  const fgNominal  = document.getElementById('fgNominal');
  const fgPayment  = document.getElementById('fgPayment');
  const lblUserId  = document.getElementById('lblUserId');
  const lblServer  = document.getElementById('lblServer');
  const lblNickname= document.getElementById('lblNickname');
  const userIdInput = document.getElementById('userId');
  const serverInput = document.getElementById('server');
  const nicknameInput = document.getElementById('nickname');
  const phoneNumberInput = document.getElementById('phoneNumber');
  const emailFreshWarn = document.getElementById('emailFreshWarn');
  
  const APK_SPECIAL_EMAIL = new Set(['YouTube Premium','Canva Pro','ChatGPT']); // These require fresh Gmail
  const APK_NETFLIX = 'Netflix Premium';
  const isEmailApp = APK_SPECIAL_EMAIL.has(productName);
  const isNetflix = productName === APK_NETFLIX;
  const isGame = catalog.find(p => p.name === productName && p.cat === 'game');
  const isOtherAPK = apkProducts.includes(productName) && !isEmailApp && !isNetflix;

  // Reset all fields to default hidden/text type
  emailFreshWarn.style.display = 'none';
  fgUserId.style.display = 'none';
  fgServer.style.display = 'none';
  fgNickname.style.display = 'none';

  userIdInput.type = 'text';
  userIdInput.inputMode = ''; // Clear inputmode
  userIdInput.removeAttribute('pattern'); // Clear pattern
  userIdInput.required = false;
  serverInput.required = false;
  nicknameInput.required = false;
  phoneNumberInput.required = true; // Always required

  // Reorder elements to a consistent base order for easier manipulation
  // Product -> UserId/Server/Nickname (if visible) -> Nominal -> Payment -> Phone
  form.insertBefore(fgProduct, form.firstChild); // Ensure product is first
  form.insertBefore(fgNominal, fgPayment); // Nominal before payment
  form.insertBefore(fgPhone.parentNode, fgPayment.nextSibling); // Phone after payment

  if (isGame) {
    fgUserId.style.display = 'block';
    fgServer.style.display = 'block';
    fgNickname.style.display = 'block';

    lblUserId.textContent = 'ID Pengguna';
    userIdInput.placeholder = 'Contoh: 123456789 (ID Game)';
    userIdInput.type = 'text';
    userIdInput.inputMode = 'numeric'; // Suggest numeric keyboard
    userIdInput.required = true;

    lblServer.textContent = 'Server (jika ada)';
    serverInput.placeholder = 'Contoh: Asia / 2156 (isi jika ada)';
    serverInput.required = false; // Server is optional for games

    lblNickname.textContent = 'Nama Panggilan';
    nicknameInput.placeholder = 'Contoh: BangDaimond / PlayerOne';
    nicknameInput.required = false; // Nickname is optional for games

    // Ensure correct order for games: Product -> (UserId & Server) -> (Nickname & Phone) -> Nominal -> Payment
    form.insertBefore(fgUserId.parentNode, fgNominal);
    form.insertBefore(fgNickname.parentNode, fgNominal);
    form.insertBefore(fgPhone.parentNode, fgPayment.nextSibling);

  } else if (isNetflix) {
    fgUserId.style.display = 'block';
    fgServer.style.display = 'block';
    fgNickname.style.display = 'none'; // Hide nickname for Netflix

    lblUserId.textContent = 'Nama Perangkat Pelanggan';
    userIdInput.placeholder = 'Contoh: TV Ruang Tamu / HP Andi';
    userIdInput.type = 'text';
    userIdInput.required = true;

    lblServer.textContent = 'Lokasi Perangkat';
    serverInput.placeholder = 'Contoh: Ruang Tamu / Jakarta';
    serverInput.required = true; // Server is required for Netflix

    // Reorder elements for Netflix: Product -> (UserId & Server) -> Nominal -> Payment -> Phone
    form.insertBefore(fgUserId.parentNode, fgNominal);
    form.insertBefore(fgServer.parentNode, fgNominal);
    form.insertBefore(fgPhone.parentNode, fgPayment.nextSibling);

  } else if (isEmailApp) { // YouTube Premium, Canva Pro, ChatGPT
    fgUserId.style.display = 'block';
    fgServer.style.display = 'none'; // Hide server
    fgNickname.style.display = 'none'; // Hide nickname
    emailFreshWarn.style.display = 'block'; // Show fresh email warning

    lblUserId.textContent = 'Email yang Ingin Dipremiumkan';
    userIdInput.placeholder = 'Contoh: emailbaru@gmail.com';
    userIdInput.type = 'email'; // Force email type
    userIdInput.required = true;

    // Reorder elements for Email Apps: Product -> EmailFreshWarn -> UserId -> Nominal -> Payment -> Phone
    form.insertBefore(emailFreshWarn, fgUserId.parentNode);
    form.insertBefore(fgUserId.parentNode, fgNominal);
    form.insertBefore(fgPhone.parentNode, fgPayment.nextSibling);

  } else if (isOtherAPK) { // Spotify, Adobe, Microsoft 365
    // All userId, server, nickname fields are hidden
    fgUserId.style.display = 'none';
    fgServer.style.display = 'none';
    fgNickname.style.display = 'none';
    userIdInput.required = false; // Not required for other APKs
    serverInput.required = false;
    nicknameInput.required = false;

    // Order: Product -> Nominal -> Payment -> Phone (already set by base reorder)
  }
}

function openOrderModal(productName){
  const form = document.getElementById('orderForm');
  form.reset(); // Reset form first

  document.getElementById('product').value = productName || ''; // Set product name

  generateNominalCards(productName); // Generate nominal cards
  document.getElementById('selectedNominal').value = '';
  document.getElementById('selectedPrice').value = '';
  document.getElementById('nominalWarn').classList.remove('active');

  configureOrderForm(productName); // Configure form fields based on product type

  openModal('orderModal'); // Open the modal
}

function generateNominalCards(productName){
  const box=document.getElementById('nominalCards');box.innerHTML='';
  const arr=productData[productName]||[];
  if(!arr.length){box.innerHTML=`<div style="text-align:center;color:var(--text-secondary);padding:10px">Nominal belum tersedia.</div>`;return}
  arr.forEach(it=>{
    const d=document.createElement('div');
    d.className='nominal-card';
    d.setAttribute('tabindex', '0'); // Make nominal cards focusable
    d.setAttribute('role', 'radio'); // Indicate it's a selectable option
    d.setAttribute('aria-checked', 'false');
    d.dataset.nominal=it.nominal;
    d.dataset.price=it.price;
    d.innerHTML=`<div class="nominal-value">${it.nominal}</div><div class="nominal-price">Rp ${it.price.toLocaleString('id-ID')}</div>${it.bonus?`<div class="nominal-bonus">${it.bonus}</div>`:''}`
    d.onclick=(ev)=>{
      document.querySelectorAll('.nominal-card').forEach(x=>{
        x.classList.remove('selected');
        x.setAttribute('aria-checked', 'false');
      });
      d.classList.add('selected');
      d.setAttribute('aria-checked', 'true');
      document.getElementById('selectedNominal').value=it.nominal;
      document.getElementById('selectedPrice').value=it.price;
      document.getElementById('nominalWarn').classList.remove('active');
    }
    box.appendChild(d);
  });
}

/* Submit Order -> PAYFX Checkout */
document.getElementById('orderForm').addEventListener('submit',async (e)=>{
  e.preventDefault();
  const productName = document.getElementById('product').value.trim();
  const userIdInput = document.getElementById('userId');
  const serverInput = document.getElementById('server');
  const nicknameInput = document.getElementById('nickname');
  const selectedNominal = document.getElementById('selectedNominal').value;
  const paymentMethod = document.getElementById('payment').value;
  const phoneNumberInput = document.getElementById('phoneNumber');

  if (!productName) {
    toast('Produk belum dipilih.');
    return;
  }

  const APK_SPECIAL_EMAIL = new Set(['YouTube Premium','Canva Pro','ChatGPT']);
  const APK_NETFLIX = 'Netflix Premium';
  const isEmailApp = APK_SPECIAL_EMAIL.has(productName);
  const isNetflix = productName === APK_NETFLIX;
  const isGame = catalog.find(p => p.name === productName && p.cat === 'game');
  const isOtherAPK = apkProducts.includes(productName) && !isEmailApp && !isNetflix;

  // --- Validasi berdasarkan jenis produk ---
  if (isGame) {
    if (!userIdInput.value.trim()) {
      toast('ID Pengguna wajib diisi.');
      return;
    }
    // No email validation for game IDs
  } else if (isNetflix) {
    if (!userIdInput.value.trim()) {
      toast('Nama Perangkat Pelanggan wajib diisi.');
      return;
    }
    if (!serverInput.value.trim()) {
      toast('Lokasi Perangkat wajib diisi.');
      return;
    }
  } else if (isEmailApp) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(userIdInput.value.trim())) {
      toast('Format email tidak valid untuk aktivasi.');
      return;
    }
  } else if (isOtherAPK) {
    // No specific userId/server/nickname validation for these, as they are hidden
  }

  if(!selectedNominal){
    document.getElementById('nominalWarn').classList.add('active');
    document.getElementById('nominalCards').scrollIntoView({behavior:'smooth',block:'center'});
    toast('Silakan pilih nominal terlebih dahulu.');
    return;
  }

  if (!paymentMethod) {
    toast('Metode Pembayaran wajib dipilih.');
    return;
  }

  if (!phoneNumberInput.value.trim()) {
    toast('Nomor HP wajib diisi.');
    return;
  }

  const fd=new FormData(e.target);
  const data=Object.fromEntries(fd.entries());

  // Create orderId
  const orderId='DK'+Math.floor(10000+Math.random()*90000);
  let metaData = {};

  if (isNetflix) {
    metaData = {
      uid: data.userId, // Nama Perangkat Pelanggan
      server: data.server, // Lokasi Perangkat
      nick: '',
      phone: data.phoneNumber
    };
  } else if (isEmailApp) {
    metaData = {
      uid: data.userId, // Email yang ingin dipremiumkan
      server: '',
      nick: '',
      phone: data.phoneNumber
    };
  } else if (isOtherAPK) {
    metaData = {
      uid: '', // Not applicable for other APKs
      server: '', // Not applicable for other APKs
      nick: '', // Not applicable for other APKs
      phone: data.phoneNumber
    };
  } else { // Default: Game Top-up
    metaData = {
      uid: data.userId,
      server: data.server || '',
      nick: data.nickname || '',
      phone: data.phoneNumber
    };
  }

  const order={
    id:orderId,
    userId:window.currentUserUid || null, // Use Firebase UID
    product:data.product,
    nominal:data.nominal,
    price:+data.price,
    payment:data.payment,
    meta:metaData,
    status:'pending',
    createdAt: window.serverTimestamp() // Use modular serverTimestamp()
  };
  
  // Save order to Firestore using modular syntax
  try {
    await window.setDoc(window.doc(window.db, "orders", orderId), order);
    toast('Pesanan berhasil dibuat!');
  } catch (error) {
    console.error("Error adding order to Firestore: ", error);
    toast('Gagal membuat pesanan: ' + error.message);
    return;
  }

  // Buka PAYFX sesuai pilihan (qris/dana)
  closeModal('orderModal');
  const fxMethod = (order.payment === 'qris') ? 'qris' : 'dana';
  openPay({ id: order.id, product: order.product, item: order.nominal, price: order.price, method: fxMethod });
});

function fillSummary(o){
  const s=document.getElementById('summaryBox');
  s.innerHTML = `
    <div class="row">
      <div><div class="chip">Produk</div><div class="mt8">${o.product}</div></div>
      <div><div class="chip">Item</div><div class="mt8">${o.nominal}</div></div>
    </div>
    <div class="row mt12">
      <div><div class="chip">ID</div><div class="mt8">${o.meta.uid}${o.meta.server?` (Server ${o.meta.server})`:''}</div></div>
      <div><div class="chip">Nama Panggilan</div><div class="mt8">${o.meta.nick||'-'}</div></div>
    </div>
    <div class="row mt12">
      <div><div class="chip">Nomor HP</div><div class="mt8">${o.meta.phone||'-'}</div></div>
      <div><div class="chip">Total Bayar</div><div class="mt8 accent"><b>Rp ${o.price.toLocaleString('id-ID')}</b></div></div>
    </div>
    <div class="mt12"><div class="chip">ID Pesanan</div><div class="mt8" id="sumOrderId">${o.id}</div></div>
  `;

  // Payment sheet — hanya QRIS & DANA
  const payMeta=document.getElementById('payMeta');
  const payIns=document.getElementById('payInstruction');
  payMeta.innerHTML='';document.getElementById('countdownWrap').style.display='block';
  if(o.payment==='qris'){
    payIns.innerHTML='Scan QRIS berikut lalu bayar sesuai total. Jangan tutup halaman ini saat sistem mengecek pembayaran.';
    payMeta.innerHTML=`<div class="chip">QRIS</div><div class="chip">Admin +1%</div>`;
  }else{
    payIns.innerHTML='Lakukan transfer ke DANA berikut lalu kembali ke halaman ini.';
    payMeta.innerHTML=`<div class="chip">DANA</div><div class="chip">a.n. DiamondKu</div>`;
  }

  // start countdown simulasi 15 menit
  startCountdown(15*60, document.getElementById('countdown'));
  // hook sudah bayar
  document.getElementById('alreadyPaidBtn').onclick=()=>{
    document.getElementById('proofOrderId').value=o.id;
    closeModal('confirmModal');openModal('proofModal');
  };
}

/* Countdown */
let cdTimer=null;
function startCountdown(sec, target){
  clearInterval(cdTimer);
  function fmt(s){const m=String(Math.floor(s/60)).padStart(2,'0');const d=String(s%60).padStart(2,'0');return m+':'+d}
  target.textContent=fmt(sec);
  cdTimer=setInterval(()=>{sec--;target.textContent=fmt(Math.max(sec,0));if(sec<=0)clearInterval(cdTimer)},1000);
}

/* Upload bukti / Kirim ke grup */
document.getElementById('sendProofBtn').onclick=async ()=>{
  const oid=document.getElementById('proofOrderId').value;
  const trx=document.getElementById('trxNo').value.trim();
  const file=document.getElementById('proofFile').files[0];
  if(!trx){toast('Masukkan nomor transaksi.');return}
  if(!file){toast('Pilih bukti transfer.');return}
  
  // Update order status in Firestore using modular syntax
  try {
    const orderRef = window.doc(window.db, 'orders', oid);
    await window.updateDoc(orderRef, { status: 'processing', transactionNo: trx });
    boomConfetti(120);
    toast('Bukti terkirim. Pesanan masuk antrean proses.');
    closeModal('proofModal');
  } catch (error) {
    console.error("Error updating order status in Firestore: ", error);
    toast('Gagal mengirim bukti. Silakan coba lagi.');
  }
}

document.getElementById('sendToGroupBtn').onclick=()=>{
  const oid=document.getElementById('proofOrderId').value;
  const od=orders.find(o=>o.id===oid); // orders array is now updated by Firestore listener
  if (!od) {
    toast('Pesanan tidak ditemukan di data lokal.');
    return;
  }
  const msg = `ORDER BARU%0AID: ${oid}%0AProduk: ${od?.product}%0AItem: ${od?.nominal}%0ATotal: Rp ${od?od.price.toLocaleString('id-ID'):''}%0AMetode: ${od?.payment}%0AUserID: ${od?.meta.uid}%0AServer: ${od?.meta.server||'-'}%0ANick: ${od?.meta.nick||'-'}`;
  // BISA diarahkan ke grup WA kamu: ganti "62812xxxx" dengan nomor / link grup WA Invite
  const wa = `https://wa.me/6281234567890?text=${msg}`;
  window.open(wa,'_blank');
}

/* ===================== ORDER HISTORY ===================== */
function loadOrderHistory(){
  const box=document.getElementById('orderHistoryContainer');
  if(!window.currentUserUid){box.innerHTML=emptyBox('Anda harus masuk untuk melihat riwayat pesanan.');return}
  
  // This function will be called by the onSnapshot listener in Firebase SDK section
  // The actual rendering happens when the 'orders' array is updated by the listener
  if (orders.length === 0) {
    box.innerHTML = emptyBox('Belum ada pesanan.');
    return;
  }

  let list = [...orders]; // Create a copy to sort
  list.sort((a,b)=>new Date(b.createdAt?.toDate() || 0)-new Date(a.createdAt?.toDate() || 0)); // Sort by Firestore timestamp

  box.innerHTML=list.map(o=>{
    const st = o.status==='pending'?'Menunggu Pembayaran':o.status==='processing'?'Sedang Diproses':o.status==='completed'?'Selesai':'Dibatalkan';
    return `<div class="paybox" style="margin-bottom:12px">
      <div class="row">
        <div><div class="chip">ID Pesanan</div><div class="mt8"><b>${o.id}</b></div></div>
        <div><div class="chip">Status</div><div class="mt8">${st}</div></div>
      </div>
      <div class="row mt12">
        <div><div class="chip">Produk</div><div class="mt8">${o.product}</div></div>
        <div><div class="chip">Item</div><div class="mt8">${o.nominal}</div></div>
      </div>
      <div class="row mt12">
        <div><div class="chip">Total</div><div class="mt8 accent">Rp ${o.price.toLocaleString('id-ID')}</div></div>
        <div style="display:grid;align-items:end"><button class="ghost-btn" onclick="viewOrder('${o.id}')">Lihat Detail</button></div>
      </div>
    </div>`
  }).join('');
}
function viewOrder(id){
  const o=orders.find(x=>x.id===id); // orders array is now updated by Firestore listener
  if(!o)return;
  const fxMethod = (o.payment === 'qris') ? 'qris' : 'dana';
  openPay({ id: o.id, product: o.product, item: o.nominal, price: o.price, method: fxMethod });
}

/* ===================== CEK PESANAN (ID SAJA) ===================== */
document.getElementById('checkOrderForm').addEventListener('submit',async (e)=>{
  e.preventDefault();
  const id=document.getElementById('checkOrderId').value.trim();
  
  let o = null;
  try {
    const docRef = window.doc(window.db, 'orders', id); // Use modular doc
    const docSnap = await window.getDoc(docRef); // Use modular getDoc
    if (docSnap.exists()) {
      o = docSnap.data();
    }
  } catch (error) {
    console.error("Error fetching order from Firestore: ", error);
  }

  if(!o){toast('Pesanan tidak ditemukan.');return}
  
  document.getElementById('trackingWrap').style.display='block';
  document.getElementById('trackingTitle').textContent='Status Pesanan #'+o.id;
  const pay=document.getElementById('tPay'),proc=document.getElementById('tProc'),done=document.getElementById('tDone');
  const trackProgress = document.getElementById('trackProgress');
  const trackingWrap = document.getElementById('trackingWrap');

  pay.className='t-ico';proc.className='t-ico';done.className='t-ico';
  let progress=25;
  if(o.status==='pending'){
    pay.classList.add('active');
    progress=40;
  }
  if(o.status==='processing'){
    pay.classList.add('done');
    proc.classList.add('active');
    progress=70;
  }
  if(o.status==='completed'){
    pay.classList.add('done');
    proc.classList.add('done');
    done.classList.add('active');
    progress=100;
  }
  trackProgress.style.width=progress+'%';
  trackingWrap.setAttribute('aria-valuenow', progress);

  document.getElementById('trackDetail').innerHTML=`
    <div><b>Produk:</b> ${o.product}</div>
    <div><b>Item:</b> ${o.nominal}</div>
    <div><b>ID:</b> ${o.meta.uid}${o.meta.server?` (Server ${o.meta.server})`:''}</div>
    <div><b>Metode:</b> ${o.payment}</div>
    <div><b>Total:</b> Rp ${o.price.toLocaleString('id-ID')}</div>
    <div><b>Tanggal:</b> ${o.createdAt?.toDate().toLocaleString('id-ID') || 'N/A'}</div>
  `;
});

/* ===================== FAQ ===================== */
const faqs=[
  {q:'Bagaimana cara melakukan top up?',a:`1) Pilih produk → 2) Isi ID & server (jika ada) → 3) Pilih nominal → 4) Pilih metode → 5) Bayar → 6) Upload bukti & nomor transaksi → 7) Selesai.`},
  {q:'Metode pembayaran apa saja yang tersedia?',a:`Saat ini kami menerima pembayaran melalui QRIS dan DANA.`},
  {q:'Berapa lama proses top up atau aktivasi?',a:`Proses top up biasanya instan, sekitar 1–5 menit setelah pembayaran terverifikasi (untuk QRIS/DANA). Jika ada keterlambatan, silakan hubungi layanan pelanggan kami.`},
  {q:'Apakah data akun game saya aman?',a:`Ya, keamanan data Anda adalah prioritas kami. Pembayaran dilakukan melalui gateway tepercaya dan data Anda terenkripsi. Kami tidak pernah meminta password akun game Anda.`},
  {q:'Top up saya belum masuk, apa yang harus saya lakukan?',a:`Pertama, pastikan Anda telah memasukkan ID/server dengan benar dan status pembayaran Anda sudah berhasil. Tunggu sebentar, terkadang ada sedikit delay. Jika masih belum masuk, silakan kirim bukti pembayaran dan nomor transaksi melalui formulir "Sudah Bayar" yang tersedia.`}
];
function renderFAQ(){
  const w=document.getElementById('faqWrap');w.innerHTML='';
  faqs.forEach((f, index)=>{
    const it=document.createElement('div');it.className='faq-item';
    const faqId = `faq-${index}`;
    it.innerHTML=`
      <div class="faq-q" role="button" aria-expanded="false" aria-controls="${faqId}-answer" id="${faqId}-question" tabindex="0">
        <span>${f.q}</span><span class="faq-icon" aria-hidden="true">▼</span>
      </div>
      <div class="faq-a" id="${faqId}-answer" role="region" aria-labelledby="${faqId}-question" hidden>
        <p style="padding-top:12px">${f.a.replaceAll('\n','<br>')}</p>
      </div>`;
    it.querySelector('.faq-q').onclick=()=>{
      const isActive = it.classList.toggle('active');
      it.querySelector('.faq-q').setAttribute('aria-expanded', isActive);
      it.querySelector('.faq-a').toggleAttribute('hidden', !isActive);
    };
    w.appendChild(it);
  })
}

/* ===================== TESTIMONI & PROMO (static demo) ===================== */
function renderTesti(){
  const w=document.getElementById('testiGrid');
  const data=[
    {name:'Ahmad Rizki', avatar:'https://i.imgur.com/7XjJY5v.png', rate:'★★★★★', text:'Top up ML saya masuk dalam hitungan menit. Mantap! Prosesnya cepat dan mudah.'},
    {name:'Siti Nurhaliza', avatar:'https://i.imgur.com/6XjJY5v.png', rate:'★★★★★', text:'Langganan Netflix Premium selalu aman dan cepat di sini. Sangat direkomendasikan!'},
    {name:'Budi Santoso', avatar:'https://i.imgur.com/5vQzZqM.png', rate:'★★★★☆', text:'Pembayaran mudah, dan layanan pelanggan sangat responsif. Sedikit delay tapi teratasi.'},
    {name:'Maya Putri', avatar:'https://i.imgur.com/4ZQqZQx.png', rate:'★★★★★', text:'Spotify Premium langsung aktif, tanpa ribet. Pengalaman top up terbaik sejauh ini!'},
  ];
  w.innerHTML=data.map(d=>`<div class="paybox" role="article" aria-label="Testimoni dari ${d.name}">
    <div style="display:flex;gap:12px;align-items:center">
      <img src="${d.avatar}" alt="Avatar ${d.name}" style="width:56px;height:56px;border-radius:50%;border:3px solid var(--accent)" width="56" height="56" loading="lazy">
      <div>
        <div class="accent" style="font-weight:900">${d.name}</div>
        <div role="img" aria-label="Rating ${d.rate}">${d.rate}</div>
      </div>
    </div>
    <p class="mt12" style="color:var(--text-secondary);font-style:italic">"${d.text}"</p>
  </div>`).join('');
}
function renderPromo(){
  const w=document.getElementById('promoGrid');
  const promos=[
    {name:'Cashback 20% Semua Game', img:'https://i.imgur.com/3ZQqZQx.png', alt:'Promo Cashback 20% Semua Game'},
    {name:'Bonus 30% Diamond Mobile Legends', img:'https://i.imgur.com/2ZQqZQx.png', alt:'Promo Bonus 30% Diamond Mobile Legends'},
    {name:'Diskon 25% Langganan Netflix Premium', img:'https://i.imgur.com/1ZQqZQx.png', alt:'Promo Diskon 25% Netflix Premium'},
    {name:'Voucher Gratis Rp 50.000', img:'https://i.imgur.com/0ZQqZQx.png', alt:'Promo Voucher Gratis 50 Ribu Rupiah'},
  ];
  w.innerHTML='';
  promos.forEach(p=>{
    const card=document.createElement('div');card.className='card';
    card.setAttribute('tabindex', '0');
    card.setAttribute('role', 'button');
    card.setAttribute('aria-label', `Lihat detail promo ${p.name}`);
    card.innerHTML=`<button class="wishlist-btn" title="Tambahkan ke Wishlist" aria-label="Tambahkan promo ${p.name} ke Wishlist">♥</button><img src="${p.img}" alt="${p.alt}" width="200" height="170" loading="lazy"><div class="card-text">${p.name}</div>`;
    card.onclick=()=>openOrderModal(p.name);
    card.querySelector('.wishlist-btn').onclick=(e)=>{e.stopPropagation();toggleWishlist(p.name,e.currentTarget)}
    w.appendChild(card);
  })
}

/* ===================== INIT ===================== */
renderAllCatalog();renderFAQ();renderTesti();renderPromo();
// initUserMenu() will be called by onAuthStateChanged

/* ========== HELPERS: MODAL CLOSE ATTR ========== */
// Already handled by openModal/closeModal and event listeners

/* ========== CEGAH KOSONG: jika belum login, masih bisa pesan (userId null) ========== */

/* ========== BONUS: ENTER untuk kirim chat (jika nanti diaktifkan) ========== */

</script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, onSnapshot, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


  // TODO: Tempel konfigurasi Firebase Anda di sini, ganti __PASTE_FIREBASE_CONFIG_HERE__
  // Contoh format:
  // const firebaseConfig = {
  //   apiKey: "YOUR_API_KEY",
  //   authDomain: "YOUR_AUTH_DOMAIN",
  //   projectId: "YOUR_PROJECT_ID",
  //   storageBucket: "YOUR_STORAGE_BUCKET",
  //   messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  //   appId: "YOUR_APP_ID"
  // };
  const firebaseConfig = {
    apiKey: "AIzaSyBvPjRQAW9uRcO2Iq8ezayer9eQFPzLC_o",
    authDomain: "topup-app-59733.firebaseapp.com",
    projectId: "topup-app-59733",
    storageBucket: "topup-app-59733.firebasestorage.app",
    messagingSenderId: "252680286282",
    appId: "1:252680286282:web:0379c5e677333b2709b6b3",
    measurementId: "G-2Q5384WB3C"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Expose Firestore and serverTimestamp globally
  window.db = db;
  window.collection = collection;
  window.addDoc = addDoc;
  window.setDoc = setDoc;
  window.doc = doc;
  window.getDoc = getDoc;
  window.getDocs = getDocs;
  window.query = query;
  window.where = where;
  window.onSnapshot = onSnapshot;
  window.updateDoc = updateDoc;
  window.deleteDoc = deleteDoc;
  window.serverTimestamp = serverTimestamp;


  // Expose Firebase Auth functions globally for use in other scripts
  window.firebaseRegister = async (name, email, password) => {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(userCredential.user, { displayName: name });
      window.closeModal && closeModal('registerModal'); // Changed to close registerModal
      toast("Pendaftaran berhasil. Kamu sudah login.");
      boomConfetti(150);
    } catch (error) {
      const errorCode = error.code;
      let errorMessage = "Terjadi kesalahan.";
      switch (errorCode) {
        case 'auth/email-already-in-use':
          errorMessage = "Email ini sudah terdaftar. Silakan login.";
          break;
        case 'auth/invalid-email':
          errorMessage = "Format email tidak valid.";
          break;
        case 'auth/weak-password':
          errorMessage = "Password terlalu lemah (minimal 6 karakter).";
          break;
        default:
          errorMessage = error.message;
      }
      toast(errorMessage);
      console.error("Firebase Register Error:", error);
    }
  };

  window.firebaseSignIn = async (email, password) => {
    try {
      await signInWithEmailAndPassword(auth, email, password);
      window.closeModal && closeModal('loginModal'); // Changed to close loginModal
      toast("Berhasil masuk.");
    } catch (error) {
      const errorCode = error.code;
      let errorMessage = "Terjadi kesalahan.";
      switch (errorCode) {
        case 'auth/invalid-credential':
        case 'auth/wrong-password':
        case 'auth/user-not-found':
          errorMessage = "Email atau password salah.";
          break;
        case 'auth/invalid-email':
          errorMessage = "Format email tidak valid.";
          break;
        default:
          errorMessage = error.message;
      }
      toast(errorMessage);
      console.error("Firebase Sign In Error:", error);
    }
  };

  window.firebaseSignOut = async () => {
    try {
      await signOut(auth);
      // toast("Kamu sudah keluar."); // Toast handled by onAuthStateChanged
    } catch (error) {
      toast("Gagal keluar: " + error.message);
      console.error("Firebase Sign Out Error:", error);
    }
  };

  let unsubscribeOrders = null;
  let unsubscribeWishlist = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      // User is signed in
      document.body.dataset.authed = "true";
      window.currentUserUid = user.uid;
      initUserMenu(user); // Update UI for logged-in user
      console.log("User logged in:", user.uid, user.displayName || user.email);

      // Setup Firestore listeners
      const ordersColRef = collection(db, 'orders');
      const qOrders = query(ordersColRef, where('userId', '==', user.uid));
      unsubscribeOrders = onSnapshot(qOrders, (snapshot) => {
        orders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        if (document.getElementById('orderHistory').classList.contains('active')) {
          loadOrderHistory();
        }
      }, (error) => {
        console.error("Error listening to orders: ", error);
        toast("Gagal memuat riwayat pesanan.");
      });

      const wishlistColRef = collection(db, 'wishlists');
      const qWishlist = query(wishlistColRef, where('userId', '==', user.uid));
      unsubscribeWishlist = onSnapshot(qWishlist, (snapshot) => {
        wishlist = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        if (document.getElementById('wishlist').classList.contains('active')) {
          loadWishlist();
        }
      }, (error) => {
        console.error("Error listening to wishlist: ", error);
        toast("Gagal memuat wishlist.");
      });

    } else {
      // User is signed out
      document.body.dataset.authed = "false";
      window.currentUserUid = null;
      initUserMenu(null); // Update UI for logged-out user
      console.log("User logged out");
      toast('Kamu sudah keluar.'); // Show toast on logout

      // Detach Firestore listeners
      if (unsubscribeOrders) {
        unsubscribeOrders();
        unsubscribeOrders = null;
      }
      if (unsubscribeWishlist) {
        unsubscribeWishlist();
        unsubscribeWishlist = null;
      }
      orders = []; // Clear local orders array
      wishlist = []; // Clear local wishlist array
      loadOrderHistory(); // Update UI to show empty state
      loadWishlist(); // Update UI to show empty state
    }
  });
</script>

<!-- === PAYFX: Checkout Full FX (scoped, no theme overwrite) === -->
<style>
  /* PAYFX Specific Styles */
  .payfx-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.86);backdrop-filter:blur(10px);z-index:1000}
  .payfx-modal.active{display:flex}
  .payfx-inner{position:relative;width:min(1080px,95%);background:rgba(22,22,22,.94);border:1px solid var(--brd);border-radius:26px;padding:22px 22px 26px;overflow:hidden}
  .payfx-close{position:absolute;right:14px;top:14px;width:40px;height:40px;border-radius:999px;border:1px solid var(--brd);background:rgba(255,255,255,.06);color:var(--ac);font-size:20px}
  .payfx-topbar{position:absolute;left:0;top:0;height:4px;width:0;background:linear-gradient(90deg,var(--ac),var(--ac2),var(--ac3));box-shadow:0 0 18px rgba(251,176,59,.6);transition:width .6s}
  .payfx-title{font-size:30px;text-align:center;margin:6px 0 4px;color:var(--ac);text-shadow:0 0 18px rgba(251,176,59,.25)}
  .payfx-sub{margin:0 0 14px;text-align:center;color:var(--muted)}
  .payfx-grid{display:grid;grid-template-columns:1.45fr .9fr;gap:16px}
  .payfx-card{background:rgba(255,255,255,.04);border:1px solid var(--brd);border-radius:16px;padding:14px 16px;position:relative;overflow:hidden}
  .payfx-card h3{margin:0 0 10px;color:var(--ac);font-size:18px}
  .payfx-row{display:flex;justify-content:space-between;margin:10px 0}
  .payfx-k{color:var(--muted)} .payfx-v{font-weight:700}
  .payfx-tabs{display:flex;gap:8px;margin-bottom:10px}
  .payfx-tab{padding:8px 12px;border-radius:10px;border:1px solid var(--brd);background:rgba(255,255,255,.03);color:var(--muted);font-weight:700;cursor:pointer}
  .payfx-tab.active{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#111;border:none;box-shadow:0 6px 18px rgba(251,176,59,.25)}
  .payfx-skel{height:16px;border-radius:10px;background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.16),rgba(255,255,255,.06));background-size:200% 100%;animation:shimmer 1.15s linear infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .payfx-btn{padding:11px 14px;border-radius:12px;border:1px solid var(--ac);color:var(--ac);background:transparent;font-weight:800;letter-spacing:.2px;cursor:pointer}
  /* Modified .payfx-btn.pri for "Sudah Bayar" button */
  .payfx-btn.pri {
    background: linear-gradient(135deg, var(--accent), var(--accent-hover)); /* Use accent colors */
    border: none;
    color: #111; /* Dark text for contrast */
  }
  .payfx-toast{position:fixed;left:50%;top:22px;transform:translateX(-50%) translateY(-12px);background:linear-gradient(135deg,rgba(46,204,113,.95),rgba(39,174,96,.95));color:#111;padding:12px 16px;border-radius:12px;font-weight:800;opacity:0;z-index:120}
  .payfx-toast.show{opacity:1;transform:translateX(-50%) translateY(0);transition:.35s}
  .payfx-ring{width:74px;height:74px;display:flex;align-items:center;justify-content:center}
  .payfx-banner{display:none;text-align:center;margin:4px 0 8px}
  .payfx-banner.active{display:block;animation:payfx-pop .28s ease}
  .payfx-banner .c{width:92px;height:92px;border-radius:50%;border:2px solid #2ecc71;color:#2ecc71;margin:8px auto 6px;display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(46,204,113,.38);font-size:30px}
  @keyframes payfx-pop{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
  #payfx-confetti,#payfx-pbg{position:absolute;inset:0;pointer-events:none}
  #payfx-pbg{opacity:.25;filter:blur(1px)}
  @media(max-width:820px){.payfx-grid{grid-template-columns:1fr}}
</style>

<div id="payfx-modal" class="payfx-modal" role="dialog" aria-modal="true" aria-labelledby="payfx-title" tabindex="-1">
  <div class="payfx-inner">
    <div id="payfx-topbar" class="payfx-topbar"></div>
    <canvas id="payfx-confetti" aria-hidden="true"></canvas>
    <canvas id="payfx-pbg" aria-hidden="true"></canvas>
    <button class="payfx-close" onclick="closePay()" aria-label="Tutup jendela pembayaran">×</button>
    <h2 class="payfx-title" id="payfx-title">Pembayaran</h2>
    <p class="payfx-sub">Jangan tutup halaman ini. Sistem akan otomatis mengecek pembayaran Anda.</p>

    <div id="payfx-banner" class="payfx-banner" role="status" aria-live="assertive">
      <div class="c" aria-hidden="true">✓</div>
      <div>Pembayaran berhasil! Pesanan sedang diproses.</div>
    </div>

    <div class="payfx-grid">
      <div class="payfx-card">
        <h3>Metode Pembayaran</h3>
        <div class="payfx-tabs" role="tablist">
          <button id="payfx-tabQR"   class="payfx-tab active" onclick="switchMethod('qris')" role="tab" aria-selected="true" aria-controls="payfx-widget">QRIS</button>
          <button id="payfx-tabDANA" class="payfx-tab"        onclick="switchMethod('dana')" role="tab" aria-selected="false" aria-controls="payfx-widget">DANA</button>
        </div>
        <div id="payfx-widget" role="tabpanel" aria-labelledby="payfx-tabQR">
          <div class="payfx-skel" style="width:60%;margin-bottom:10px"></div>
          <div class="payfx-skel" style="height:340px;border-radius:12px"></div>
          <div class="payfx-skel" style="width:80%;margin-top:10px"></div>
        </div>
        <div id="payfx-steps" style="margin-top:10px;color:var(--muted);font-size:14px"></div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="payfx-btn pri" onclick="openProofFlow()">Sudah Bayar</button>
          <button class="payfx-btn" onclick="closePay()">Batalkan</button>
        </div>
      </div>

      <div class="payfx-card">
        <h3>Ringkasan Pesanan</h3>
        <div class="payfx-row"><span class="payfx-k">ID Pesanan</span><span class="payfx-v" id="payfx-sumId">-</span></div>
        <div class="payfx-row"><span class="payfx-k">Produk</span><span class="payfx-v" id="payfx-sumProd">-</span></div>
        <div class="payfx-row"><span class="payfx-k">Item</span><span class="payfx-v" id="payfx-sumItem">-</span></div>
        <div class="payfx-row"><span class="payfx-k">Metode</span><span class="payfx-v" id="payfx-sumMet">-</span></div>
        <div class="payfx-row"><span class="payfx-k">Total</span><span class="payfx-v" id="payfx-sumTot">Rp 0</span></div>
        <div class="payfx-row" style="align-items:center;gap:10px">
          <span class="payfx-k">Batas Waktu</span>
          <span class="payfx-v" style="display:flex;align-items:center;gap:10px">
            <span id="payfx-cdText" style="min-width:52px;display:inline-block" aria-live="polite">15:00</span>
            <span class="payfx-ring" role="timer" aria-label="Batas waktu pembayaran">
              <svg width="74" height="74">
                <circle cx="37" cy="37" r="30" stroke="rgba(255,255,255,.15)" stroke-width="6" fill="none"></circle>
                <circle id="payfx-cdRing" cx="37" cy="37" r="30" stroke="var(--ac)" stroke-width="6" fill="none" stroke-linecap="round"></circle>
              </svg>
            </span>
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="payfx-toast" class="payfx-toast" role="status" aria-live="polite">Disalin ke clipboard</div>

<script>
/* ====== KONFIG (ganti nanti) ====== */
const QRIS_STATIC = '000201010212.ABCD'; // Placeholder QRIS static code
const DANA_NUMBER = '081234567890'; // Placeholder DANA number

const rupiah = n => 'Rp ' + Number(n||0).toLocaleString('id-ID');
function payfxToast(msg){
  const t=document.getElementById('payfx-toast');
  t.textContent=msg||'Disalin ke clipboard';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1500);
}

const AudioFX = (()=>{
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const now=()=>ctx.currentTime;
  function blip(freq=880,dur=.08,type='sine',vol=.2){
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type=type;o.frequency.value=freq;g.gain.value=vol;
    o.connect(g).connect(ctx.destination);o.start();o.stop(now()+dur);
  }
  function sweep(start=600,end=1200,dur=.23,type='triangle',vol=.22){
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type=type;o.frequency.setValueAtTime(start,now());
    o.frequency.exponentialRampToValueAtTime(end,now()+dur);
    g.gain.setValueAtTime(0,now());
    g.gain.linearRampToValueAtTime(vol,now()+.02);
    g.gain.exponentialRampToValueAtTime(0.0001,now()+dur);
    o.connect(g).connect(ctx.destination); o.start(); o.stop(now()+dur+.02);
  }
  function success(){ sweep(520,1040,.18,'sine',.25); setTimeout(()=>sweep(440,880,.22,'sine',.22),140); }
  function tick(){ blip(900,.05,'square',.18); }
  return {success,tick,blip};
})();

function particlesBG(){
  const cvs=document.getElementById('payfx-pbg');
  if (!cvs) return; // Guard against null canvas
  const ctx=cvs.getContext('2d');
  const w=cvs.width=cvs.offsetWidth,h=cvs.height=cvs.offsetHeight;
  const P=Array.from({length:60},()=>({x:Math.random()*w,y:Math.random()*h,vx:-.6+Math.random()*1.2,vy:-.4+Math.random()*.8,r:1+Math.random()*2}));
  (function loop(){
    if (!cvs.isConnected) return; // Stop animation if canvas is removed from DOM
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#fbb03b';
    P.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy;
      if(p.x<0)p.x=w; if(p.x>w)p.x=0;
      if(p.y<0)p.y=h; if(p.y>h)p.y=0;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(loop);
  })();
}

function confetti(){
  const cvs=document.getElementById('payfx-confetti');
  if (!cvs) return; // Guard against null canvas
  const ctx=cvs.getContext('2d');
  const w=cvs.width=cvs.offsetWidth,h=cvs.height=cvs.offsetHeight;
  const pieces=Array.from({length:240},()=>({x:Math.random()*w,y:-20,r:10+Math.random()*16,c:['#fbb03b','#ff7a18','#ffd166','#fff'][Math.random()*4|0],vx:-2+Math.random()*4,vy:2+Math.random()*3,a:Math.random()*Math.PI}));
  let life=0;
  (function anim(){
    if (!cvs.isConnected) return; // Stop animation if canvas is removed from DOM
    life++;
    ctx.clearRect(0,0,w,h);
    pieces.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;p.vy+=0.03;p.a+=0.05;
      ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.a);ctx.fillStyle=p.c;ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);ctx.restore();
    });
    if(life<260) requestAnimationFrame(anim);
    else ctx.clearRect(0,0,w,h);
  })();
}

let payfxTimer=null;
function startCountdown(mins){
  if(payfxTimer) clearInterval(payfxTimer);
  const total=mins*60*1000,start=Date.now(),circ=2*Math.PI*30;
  const cdRing=document.getElementById('payfx-cdRing'), cdText=document.getElementById('payfx-cdText'), topbar=document.getElementById('payfx-topbar');
  cdRing.setAttribute('stroke-dasharray', String(circ));
  function tick(){
    const elapsed=Date.now()-start,left=Math.max(0,total-elapsed),r=1-left/total;
    const m=(left/60000)|0,s=((left%60000)/1000)|0;
    cdText.textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    topbar.style.width=(r*100)+'%';
    cdRing.setAttribute('stroke-dashoffset', String(r*circ));
    if(s%5===0 && left>0) AudioFX.tick();
    if(left<=0) clearInterval(payfxTimer);
  }
  tick();
  payfxTimer=setInterval(tick,250);
}

let currentOrder={id:'DK00000',product:'Produk',item:'-',price:12000,method:'qris'};
window.openPay=function(order){
  const m=document.getElementById('payfx-modal');
  const sumId=document.getElementById('payfx-sumId');
  const sumProd=document.getElementById('payfx-sumProd');
  const sumItem=document.getElementById('payfx-sumItem');
  const sumMet=document.getElementById('payfx-sumMet');
  const sumTot=document.getElementById('payfx-sumTot');

  currentOrder=Object.assign({},currentOrder,order||{});
  sumId.textContent=currentOrder.id;
  sumProd.textContent=currentOrder.product;
  sumItem.textContent=currentOrder.item;
  sumMet.textContent=currentOrder.method==='qris'?'QRIS':'DANA';
  sumTot.textContent=rupiah(currentOrder.price);

  // ======= BATASI TAB SESUAI PILIHAN USER =======
  const tabQR   = document.getElementById('payfx-tabQR');
  const tabDANA = document.getElementById('payfx-tabDANA');
  if(currentOrder.method==='qris'){
    tabQR.style.display='inline-block';
    tabDANA.style.display='none';
    tabQR.classList.add('active');
    tabQR.setAttribute('aria-selected', 'true');
    tabDANA.classList.remove('active');
    tabDANA.setAttribute('aria-selected', 'false');
    document.getElementById('payfx-widget').setAttribute('aria-labelledby', 'payfx-tabQR');
  }else{
    tabQR.style.display='none';
    tabDANA.style.display='inline-block';
    tabDANA.classList.add('active');
    tabDANA.setAttribute('aria-selected', 'true');
    tabQR.classList.remove('active');
    tabQR.setAttribute('aria-selected', 'false');
    document.getElementById('payfx-widget').setAttribute('aria-labelledby', 'payfx-tabDANA');
  }
  // ==============================================

  document.getElementById('payfx-banner').classList.remove('active');
  document.getElementById('payfx-topbar').style.width='0%';
  renderWidget();
  startCountdown(15);
  openModal('payfx-modal'); // Use the common openModal function
  particlesBG();
  setTimeout(()=>AudioFX.tick(),80);
};

window.closePay=function(){
  closeModal('payfx-modal'); // Use the common closeModal function
};

window.switchMethod=function(m){
  // Blok switching ke metode lain; hanya izinkan klik kalau sama dengan pilihan user
  if(m!==currentOrder.method) return;
  // (Tetap render ulang widget bila user klik tab yang sama – aman/tidak mengubah state)
  document.getElementById('payfx-sumMet').textContent = (m==='qris') ? 'QRIS' : 'DANA';
  renderWidget();
  AudioFX.tick();
};

/* === UBAHAN: fungsi pembuka alur upload bukti dari PAYFX === */
window.openProofFlow = function () {
  closeModal('payfx-modal'); // Use the common closeModal function
  const pid = document.getElementById('proofOrderId');
  if (pid) pid.value = currentOrder?.id || '';
  openModal('proofModal'); // Use the common openModal function
  setTimeout(()=>document.getElementById('trxNo')?.focus(), 50);
};

function renderWidget(){
  const widget=document.getElementById('payfx-widget');
  const steps=document.getElementById('payfx-steps');
  widget.innerHTML=`<div class="payfx-skel" style="width:60%;margin-bottom:10px"></div><div class="payfx-skel" style="height:340px;border-radius:12px"></div><div class="payfx-skel" style="width:80%;margin-top:10px"></div>`;
  setTimeout(()=>{
    if(currentOrder.method==='qris'){
      widget.innerHTML=`<canvas id="payfx-qr" width="460" height="460" style="display:block;margin:6px auto;border-radius:16px" aria-label="QRIS Code"></canvas>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:8px;flex-wrap:wrap">
        <button class="payfx-btn" onclick="navigator.clipboard.writeText(QRIS_STATIC).then(()=>payfxToast('Kode QRIS disalin'))" aria-label="Salin Kode QRIS">Salin Kode QRIS</button>
        <button class="payfx-btn pri" onclick="openProofFlow()">Sudah Bayar</button></div>`;
      drawQR('payfx-qr', QRIS_STATIC);
      steps.innerHTML=`<ol style="margin:6px 0 0 18px;line-height:1.6"><li>Buka aplikasi e-wallet / m-banking Anda.</li><li>Pilih <b>Scan QRIS</b> lalu arahkan kamera ke QR di atas.</li><li>Pastikan nominal pembayaran sesuai lalu konfirmasi.</li></ol>`;
    }else{
      const prettyNo = DANA_NUMBER.replace(/(\d{4})(?=\d)/g,'$1 ').trim();
      widget.innerHTML=`<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:6px"><div style="font-size:34px;font-weight:900;letter-spacing:.8px">${prettyNo}</div></div>
      <div style="text-align:center;margin-top:10px"><button class="payfx-btn" onclick="navigator.clipboard.writeText(DANA_NUMBER).then(()=>payfxToast('Nomor DANA disalin'))" aria-label="Salin Nomor DANA">Salin Nomor DANA</button>
      <button class="payfx-btn pri" onclick="openProofFlow()">Sudah Bayar</button></div>`;
      steps.innerHTML=`<ol style="margin:6px 0 0 18px;line-height:1.6"><li>Buka aplikasi <b>DANA</b> Anda.</li><li>Lakukan transfer ke nomor di atas.</li><li>Masukkan nominal pembayaran sesuai total, lalu konfirmasi.</li></ol>`;
    }},500);
}

function drawQR(id,text='DEMO-QRIS-000201'){
  const c=document.getElementById(id);
  if(!c) return;
  const ctx=c.getContext('2d');
  const w=c.width,h=c.height;
  ctx.fillStyle='#0f0f0f'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='#fbb03b';
  for(let i=0;i<14;i++){ ctx.fillRect(18+i*22,18,12,12); ctx.fillRect(18,18+i*22,12,12); ctx.fillRect(18+i*22,h-30,12,12); ctx.fillRect(w-30,18+i*22,12,12); }
  ctx.fillStyle='#fff';
  for(let i=0;i<220;i++){ const x=(Math.random()*w)|0, y=(Math.random()*h)|0; if(x<26||y<26||x>w-26||y>h-26) continue; ctx.fillRect(x,y,7,7); }
  ctx.fillStyle='rgba(255,255,255,.85)';
  ctx.font='12px Segoe UI';
  ctx.fillText(text,14,h-10);
}

/* Catatan: markPaid() tetap ada untuk kompatibilitas, namun tidak dipanggil dari PAYFX lagi */
window.markPaid=function(){
  document.getElementById('payfx-banner').classList.add('active'); AudioFX.success(); confetti();
  // The actual status update is now handled by sendProofBtn
  setTimeout(()=>{ closeModal('payfx-modal'); document.getElementById('payfx-banner').classList.remove('active'); },1400);
};
</script>
<!-- === END PAYFX === -->


<!-- ===== Google Sheets Auto Catalog Loader ===== -->
<script>
// CSV parser safe for Google Sheets (handles quotes & commas)
function parseCsvSafe(text){
  const rows = [];
  let cur = '', row = [], inQ = false;
  for (let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if (c === '"' && n === '"'){ cur += '"'; i++; continue; }   // escaped quote
    if (c === '"'){ inQ = !inQ; continue; }                     // toggle quote
    if (c === ',' && !inQ){ row.push(cur); cur=''; continue; }  // end cell
    if ((c === '\n' || c === '\r') && !inQ){
      if (cur!=='' || row.length){ row.push(cur); rows.push(row); }
      cur=''; row=[]; continue;
    }
    cur += c;
  }
  if (cur!=='' || row.length){ row.push(cur); rows.push(row); }
  return rows;
}
function csvToObjects(text){
  const rows = parseCsvSafe(text);
  const header = rows.shift().map(h => h.trim().replace(/^\uFEFF/, ''));
  return rows.filter(r=>r.length && r.some(x => (x||'').trim().length)).map(r => {
    const obj = {};
    header.forEach((h,i)=>obj[h] = (r[i] ?? '').trim());
    return obj;
  });
}
const toInt = v => Number(String(v||'').replace(/[^\d]/g,''))||0;

// Apply promos from promo sheet
function applyPromos(basePrice, name, nominal, category, promos){
  const today = new Date();
  let best = basePrice;
  for (const p of promos||[]){
    const active = String(p.IsActive||'TRUE').toUpperCase()==='TRUE';
    if (!active) continue;
    const start = p.StartDate ? new Date(p.StartDate) : null;
    const end   = p.EndDate ? new Date(p.EndDate) : null;
    if (start && today < start) continue;
    if (end && today > end) continue;
    const scope = String(p.CategoryScope||'All').toLowerCase(); // game/apk/all
    const catOk = scope==='all' || scope===String(category||'').toLowerCase();
    if (!catOk) continue;
    if (p.ProductName && p.ProductName !== name) continue;
    if (p.NominalFilter && p.NominalFilter !== nominal) continue;
    const t = String(p.DiscountType||'').toLowerCase(); // percent/amount
    const v = toInt(p.DiscountValue);
    let discounted = basePrice;
    if (t==='percent' && v>0 && v<100) discounted = Math.round(basePrice*(1 - v/100));
    if (t==='amount'  && v>0)         discounted = Math.max(0, basePrice - v);
    if (discounted < best) best = discounted;
  }
  return best;
}

// Header helpers (tolerate minor header name differences)
function norm(k){ return String(k||'').toLowerCase().replace(/[^a-z0-9]/g,''); }
function pick(obj, keys){
  const map = {}; for (const [k,v] of Object.entries(obj)) map[norm(k)] = v;
  for (const key of keys){ const kk = norm(key); if (map[kk]!==undefined && map[kk]!=='') return map[kk]; }
  return '';
}

async function loadCatalog(){
  try{
    const URL_GAMES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQph304ET94VGs6u13Bg9qPMzt28gIFH_JQUg5jgWb0Y5l924vA1h-y8s0aFrJJaKVUGAYk57_qs94_/pub?gid=240554621&single=true&output=csv";
    const URL_APK   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQph304ET94VGs6u13Bg9qPMzt28gIFH_JQUg5jgWb0Y5l924vA1h-y8s0aFrJJaKVUGAYk57_qs94_/pub?gid=704365906&single=true&output=csv";
    const URL_PROMO = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQph304ET94VGs6u13Bg9qPMzt28gIFH_JQUg5jgWb0Y5l924vA1h-y8s0aFrJJaKVUGAYk57_qs94_/pub?gid=1185107784&single=true&output=csv";

    const [gCsv, aCsv, pCsv] = await Promise.all([
      fetch(URL_GAMES, {cache:'no-store'}).then(r=>r.text()),
      fetch(URL_APK,   {cache:'no-store'}).then(r=>r.text()),
      fetch(URL_PROMO, {cache:'no-store'}).then(r=>r.text())
    ]);

    const games = csvToObjects(gCsv);
    const apks  = csvToObjects(aCsv);
    const promos= csvToObjects(pCsv).filter(x => String(x.IsActive||'TRUE').toUpperCase()==='TRUE');

    const KEY = {
      name: ['Name','Nama','Product Name','Produk','Judul'],
      category: ['Category','Kategori','Type','Tipe'],
      nominal: ['Nominal','Variant','Varian','Paket','Item'],
      price: ['Price (Rp)','Harga (Rp)','Price','Harga','Price IDR'],
      image: ['ImageURL','Image','Gambar','Foto','Thumbnail'],
      status: ['Status','Active','Aktif'],
    };

    // Gabungkan dan filter Active
    const all = [...games, ...apks].filter(x => String(pick(x, KEY.status)||'Active').toLowerCase()==='active');

    // Build global catalog (unique by name)
    window.catalog = [];
      window.productData[name].push({ nominal, price: base, priceFinal: finalPrice });
    }

    // Re-render sections if functions exist
    if (typeof renderAllCatalog === 'function') renderAllCatalog();
    if (typeof renderPromo === 'function') renderPromo();
    if (typeof renderFAQ === 'function') renderFAQ();

    // Re-apply current filter & search
    if (typeof applyFilterSearch === 'function') {
      const cat = document.querySelector('.filter-option[data-filter].active')?.dataset.filter || 'all';
      const pr  = document.querySelector('.filter-option[data-price].active')?.dataset.price || 'all';
      const kw  = document.getElementById('searchInput')?.value?.trim() || '';
      applyFilterSearch(cat, pr, kw);
    }

    if (typeof toast === 'function') toast('Katalog dimuat dari Google Sheets.');
    console.log('[GSheet] Loaded: ', {items: Object.keys(window.productData).length, promos: promos.length});
  }catch(err){
    console.error('[GSheet] loadCatalog error:', err);
    if (typeof toast === 'function') toast('Gagal memuat katalog. Coba refresh.');
  }
}

// Jalankan setelah halaman siap
window.addEventListener('load', () => setTimeout(loadCatalog, 400));
</script>

</body>
</html>